<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.scripts.model_eval &mdash; Renal View Labeling 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Renal View Labeling
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Renal View Labeling</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.scripts.model_eval</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.scripts.model_eval</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">model_eval.py</span>

<span class="sd">Description: Used to evaluate a trained model&#39;s performance on other view</span>
<span class="sd">             labeling datasets.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Standard libraries</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Style</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># Non-standard libraries</span>
<span class="kn">import</span> <span class="nn">albumentations</span> <span class="k">as</span> <span class="nn">A</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms.v2</span> <span class="k">as</span> <span class="nn">T</span>
<span class="kn">from</span> <span class="nn">arch.bootstrap</span> <span class="kn">import</span> <span class="n">IIDBootstrap</span>
<span class="kn">from</span> <span class="nn">albumentations.pytorch.transforms</span> <span class="kn">import</span> <span class="n">ToTensorV2</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span> <span class="k">as</span> <span class="n">skmetrics</span>
<span class="kn">from</span> <span class="nn">torchvision.io</span> <span class="kn">import</span> <span class="n">read_image</span><span class="p">,</span> <span class="n">ImageReadMode</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Custom libraries</span>
<span class="kn">from</span> <span class="nn">src.data</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">src.data_prep</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">src.data_viz</span> <span class="kn">import</span> <span class="n">plot_umap</span>
<span class="kn">from</span> <span class="nn">src.data_viz</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">viz_utils</span>
<span class="kn">from</span> <span class="nn">src.scripts</span> <span class="kn">import</span> <span class="n">embed</span><span class="p">,</span> <span class="n">load_model</span><span class="p">,</span> <span class="n">load_data</span>
<span class="kn">from</span> <span class="nn">src.utils.logging</span> <span class="kn">import</span> <span class="n">load_comet_logger</span>

<span class="c1"># Configure seaborn color palette</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;Paired&quot;</span><span class="p">)</span>

<span class="c1"># Add progress_apply to pandas</span>
<span class="n">tqdm</span><span class="o">.</span><span class="n">pandas</span><span class="p">()</span>

<span class="c1">################################################################################</span>
<span class="c1">#                                  Constants                                   #</span>
<span class="c1">################################################################################</span>
<span class="c1"># Configure logging</span>
<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Flag to use GPU or not</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="c1"># Map label to encoded integer (for visualization)</span>
<span class="n">CLASS_TO_IDX</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Sagittal_Left&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Transverse_Left&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Bladder&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Transverse_Right&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Sagittal_Right&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Other&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<span class="n">IDX_TO_CLASS</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">u</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CLASS_TO_IDX</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># Plot theme (light/dark)</span>
<span class="n">THEME</span> <span class="o">=</span> <span class="s2">&quot;dark&quot;</span>

<span class="c1"># Flag to calculate metrics for each evaluation set</span>
<span class="n">CALCULATE_METRICS</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Flag to create embeddings and plot UMAP for each evaluation set</span>
<span class="n">EMBED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Flag to overwrite existing results</span>
<span class="n">OVERWRITE_EXISTING</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Flag to force bladder masking for US image datasets</span>
<span class="n">FORCE_MASK_BLADDER</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1">################################################################################</span>
<span class="c1">#                               Paths Constants                                #</span>
<span class="c1">################################################################################</span>
<span class="c1"># Model type to checkpoint file</span>
<span class="n">MODEL_TYPE_TO_CKPT</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span>
    <span class="s2">&quot;binary&quot;</span> <span class="p">:</span> <span class="s2">&quot;/binary_classifier/0/epoch=12-step=2586.ckpt&quot;</span><span class="p">,</span>

    <span class="s2">&quot;five_view&quot;</span><span class="p">:</span> <span class="s2">&quot;/five_view/0/epoch=6-step=1392.ckpt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;five_view_seq&quot;</span><span class="p">:</span> <span class="s2">&quot;cnn_lstm_8/0/epoch=31-step=5023.ckpt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;five_view_seq_w_other&quot;</span><span class="p">:</span> <span class="s2">&quot;/five_view/0/epoch=6-step=1392.ckpt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;five_view_seq_relative&quot;</span><span class="p">:</span> <span class="s2">&quot;relative_side_grid_search(2022-09-21)/relative_side&quot;</span>
                              <span class="s2">&quot;(2022-09-20_22-09)/0/epoch=7-step=1255.ckpt&quot;</span><span class="p">,</span>

    <span class="c1"># Checkpoint of MoCo Linear Classifier</span>
    <span class="s2">&quot;five_view_moco&quot;</span><span class="p">:</span> <span class="s2">&quot;moco_linear_eval_4/0/last.ckpt&quot;</span><span class="p">,</span>
    <span class="c1"># Checkpoint of MoCo LSTM + Linear Classifier</span>
    <span class="s2">&quot;five_view_moco_seq&quot;</span><span class="p">:</span> <span class="s2">&quot;moco_linear_lstm_eval_0/0/epoch=12-step=129.ckpt&quot;</span><span class="p">,</span>

    <span class="c1"># Checkpoint of MoCo (Stanford train) Linear Classifier</span>
    <span class="s2">&quot;five_view_moco_su&quot;</span><span class="p">:</span> <span class="s2">&quot;moco_linear_eval_su_to_sk_1/0/epoch=0-step=396.ckpt&quot;</span><span class="p">,</span>
    <span class="c1"># Checkpoint of MoCo (Stanford train) LSTM + Linear Classifier</span>
    <span class="s2">&quot;five_view_moco_seq_su&quot;</span><span class="p">:</span> <span class="s2">&quot;moco_linear_lstm_eval_su_to_sk_1/0/&quot;</span>
                             <span class="s2">&quot;epoch=9-step=99.ckpt&quot;</span><span class="p">,</span>

    <span class="c1"># Checkpoint of MoCo (SickKids All) Linear Classifier</span>
    <span class="s2">&quot;five_view_moco_sk_all&quot;</span><span class="p">:</span> <span class="s2">&quot;moco_linear_eval_sk_all/0/&quot;</span>
                             <span class="s2">&quot;epoch=24-step=9924.ckpt&quot;</span><span class="p">,</span>
    <span class="c1"># Checkpoint MoCo (SickKids All) LSTM + Linear</span>
    <span class="s2">&quot;five_view_moco_seq_sk_all&quot;</span><span class="p">:</span> <span class="s2">&quot;moco_linear_lstm_eval_sk_all/0/&quot;</span>
                                 <span class="s2">&quot;epoch=22-step=229.ckpt&quot;</span><span class="p">,</span>
<span class="p">})</span>

<span class="c1"># Type of models</span>
<span class="n">MODEL_TYPES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MODEL_TYPE_TO_CKPT</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<span class="c1">################################################################################</span>
<span class="c1">#                                Initialization                                #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="init">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.init">[docs]</a>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize ArgumentParser</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : argparse.ArgumentParser</span>
<span class="sd">        ArgumentParser object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arg_help</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;exp_names&quot;</span><span class="p">:</span> <span class="s2">&quot;Name/s of experiment/s (to evaluate)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dsets&quot;</span><span class="p">:</span> <span class="s2">&quot;List of dataset names to evaluate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;splits&quot;</span><span class="p">:</span> <span class="s2">&quot;Name of data splits for each `dset` to evaluate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mask_bladder&quot;</span><span class="p">:</span> <span class="s2">&quot;If True, mask bladder logit, if it&#39;s an US image dataset.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_time_aug&quot;</span><span class="p">:</span> <span class="s2">&quot;If True, perform test-time augmentations during inference.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;da_transform_name&quot;</span><span class="p">:</span>
            <span class="s2">&quot;If provided, performs domain adaptation transform on test images, &quot;</span>
            <span class="s2">&quot;by default None. Must be one of (&#39;fda&#39;, &#39;hm&#39;)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;log_to_comet&quot;</span><span class="p">:</span> <span class="s2">&quot;If True, log results to Comet ML&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--exp_names&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;exp_names&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dsets&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sickkids&quot;</span><span class="p">],</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;dsets&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--splits&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mask_bladder&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;mask_bladder&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--test_time_aug&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;test_time_aug&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--da_transform_name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;da_transform_name&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--log_to_comet&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;log_to_comet&quot;</span><span class="p">])</span></div>



<span class="c1">################################################################################</span>
<span class="c1">#                             Inference - Related                              #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="predict_on_images">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.predict_on_images">[docs]</a>
<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">predict_on_images</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">img_dir</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DSET_TO_IMG_SUBDIR_FULL</span><span class="p">[</span><span class="s2">&quot;sickkids&quot;</span><span class="p">],</span>
                      <span class="n">mask_bladder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">test_time_aug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">da_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">hparams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs inference on images specified. Returns predictions, probabilities</span>
<span class="sd">    and raw model output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : torch.nn.Module</span>
<span class="sd">        A trained PyTorch model.</span>
<span class="sd">    filenames : np.array or array-like</span>
<span class="sd">        Filenames (or full paths) to images to infer on.</span>
<span class="sd">    labels : list of str</span>
<span class="sd">        String label for each image</span>
<span class="sd">    img_dir : str, optional</span>
<span class="sd">        Path to directory containing images, by default constants.DSET_TO_IMG_SUBDIR_FULL[&quot;sickkids&quot;]</span>
<span class="sd">    mask_bladder : bool, optional</span>
<span class="sd">        If True, mask out predictions on bladder/middle side, leaving only</span>
<span class="sd">        kidney labels. Defaults to False.</span>
<span class="sd">    test_time_aug : bool, optional</span>
<span class="sd">        If True, perform test-time augmentation.</span>
<span class="sd">    da_transform : A.Compose, optional</span>
<span class="sd">        If provided, contains Domain Adaptation transform and ensures it&#39;s</span>
<span class="sd">        converted back to a PyTorch tensor, by default None.</span>
<span class="sd">    hparams : dict, optional</span>
<span class="sd">        Keyword arguments for experiment hyperparameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        For each image, contains</span>
<span class="sd">            - prediction for each image,</span>
<span class="sd">            - probability of each prediction,</span>
<span class="sd">            - raw model output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get mapping of index to class</span>
    <span class="n">label_part</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_part&quot;</span><span class="p">)</span>
    <span class="n">idx_to_class</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_PART_TO_CLASSES</span><span class="p">[</span><span class="n">label_part</span><span class="p">][</span><span class="s2">&quot;idx_to_class&quot;</span><span class="p">]</span>
    <span class="n">class_to_idx</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_PART_TO_CLASSES</span><span class="p">[</span><span class="n">label_part</span><span class="p">][</span><span class="s2">&quot;class_to_idx&quot;</span><span class="p">]</span>

    <span class="c1"># Set to evaluation mode</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="c1"># Predict on each images one-by-one</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">)):</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">filename</span> <span class="k">if</span> <span class="n">img_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">img_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Load image as expected by model</span>
        <span class="c1"># NOTE: Load as numpy, if passing into da_transform</span>
        <span class="n">as_numpy</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">da_transform</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span>
            <span class="n">img_path</span><span class="p">,</span>
            <span class="n">augment</span><span class="o">=</span><span class="n">test_time_aug</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="mi">8</span> <span class="k">if</span> <span class="n">test_time_aug</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">as_numpy</span><span class="o">=</span><span class="n">as_numpy</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Pass through da transform</span>
        <span class="k">if</span> <span class="n">da_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">da_transform</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">img</span><span class="p">)[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
            <span class="c1"># Add batch size dimension back</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Convert to float32 type and send to device</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

        <span class="c1"># Perform inference</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># If specified, remove Bladder/None as a possible prediction</span>
        <span class="c1"># NOTE: Assumes model predicts bladder/none as the 3rd index</span>
        <span class="k">if</span> <span class="n">mask_bladder</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># If test-time augmentation, averaging output across augmented samples</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Compute loss, if label provided</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">label_idx</span> <span class="o">=</span> <span class="n">class_to_idx</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">label_idx</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

        <span class="c1"># Get index of predicted label</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

        <span class="c1"># Get probability</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>

        <span class="c1"># Get maximum activation</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
        <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="c1"># Convert from encoded label to label name</span>
        <span class="n">pred_label</span> <span class="o">=</span> <span class="n">idx_to_class</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_label</span><span class="p">)</span>

    <span class="c1"># Pack into dataframe</span>
    <span class="n">df_preds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">preds</span><span class="p">,</span>
        <span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="n">probs</span><span class="p">,</span>
        <span class="s2">&quot;out&quot;</span><span class="p">:</span> <span class="n">outs</span><span class="p">,</span>
        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">losses</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">df_preds</span></div>



<span class="c1"># TODO: Implement test-time augmentations</span>
<div class="viewcode-block" id="predict_on_sequences">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.predict_on_sequences">[docs]</a>
<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">predict_on_sequences</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span>
                         <span class="n">img_dir</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DSET_TO_IMG_SUBDIR_FULL</span><span class="p">[</span><span class="s2">&quot;sickkids&quot;</span><span class="p">],</span>
                         <span class="n">mask_bladder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">test_time_aug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">hparams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs inference on a full ultrasound sequence specified. Returns</span>
<span class="sd">    predictions, probabilities and raw model output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : torch.nn.Module</span>
<span class="sd">        A trained PyTorch model.</span>
<span class="sd">    filenames : np.array or array-like</span>
<span class="sd">        Filenames (or full paths) to images from one unique sequence to infer.</span>
<span class="sd">    img_dir : str, optional</span>
<span class="sd">        Path to directory containing images, by default constants.DSET_TO_IMG_SUBDIR_FULL[&quot;sickkids&quot;]</span>
<span class="sd">    mask_bladder : bool, optional</span>
<span class="sd">        If True, mask out predictions on bladder/middle side, leaving only</span>
<span class="sd">        kidney labels. Defaults to False.</span>
<span class="sd">    hparams : dict, optional</span>
<span class="sd">        Keyword arguments for experiment hyperparameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        For each frame in the sequence, contains</span>
<span class="sd">            - prediction for each image,</span>
<span class="sd">            - probability of each prediction,</span>
<span class="sd">            - raw model output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">test_time_aug</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Get mapping of index to class</span>
    <span class="n">label_part</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_part&quot;</span><span class="p">)</span>
    <span class="n">idx_to_class</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_PART_TO_CLASSES</span><span class="p">[</span><span class="n">label_part</span><span class="p">][</span><span class="s2">&quot;idx_to_class&quot;</span><span class="p">]</span>

    <span class="c1"># Set to evaluation mode</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="c1"># Predict on each images one-by-one</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">filename</span> <span class="k">if</span> <span class="n">img_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">img_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Load image as expected by model</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">read_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">ImageReadMode</span><span class="o">.</span><span class="n">RGB</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Convert to tensor and send to device</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

    <span class="c1"># Perform inference</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="n">outs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

    <span class="c1"># If specified, remove Bladder/None as a possible prediction</span>
    <span class="c1"># NOTE: Assumes model predicts bladder/none as the 3rd index</span>
    <span class="k">if</span> <span class="n">mask_bladder</span><span class="p">:</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">outs</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Compute index of predicted label</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Get probability</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Get maximum activation</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Convert from encoded label to label name</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">idx_to_class</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)(</span><span class="n">preds</span><span class="p">)</span>

    <span class="c1"># Pack into dataframe</span>
    <span class="n">df_preds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">preds</span><span class="p">,</span>
        <span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="n">probs</span><span class="p">,</span>
        <span class="s2">&quot;out&quot;</span><span class="p">:</span> <span class="n">outs</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">df_preds</span></div>



<div class="viewcode-block" id="multi_predict_on_sequences">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.multi_predict_on_sequences">[docs]</a>
<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">multi_predict_on_sequences</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">img_dir</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DSET_TO_IMG_SUBDIR_FULL</span><span class="p">[</span><span class="s2">&quot;sickkids&quot;</span><span class="p">],</span>
                               <span class="o">**</span><span class="n">hparams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs inference on a full ultrasound sequence specified with a</span>
<span class="sd">    multi-output model. Returns predictions, probabilities and raw model output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : torch.nn.Module</span>
<span class="sd">        A trained multi-output model (EfficientNetLSTMMulti).</span>
<span class="sd">    filenames : np.array or array-like</span>
<span class="sd">        Filenames (or full paths) to images from one unique sequence to infer.</span>
<span class="sd">    img_dir : str, optional</span>
<span class="sd">        Path to directory containing images, by default constants.DSET_TO_IMG_SUBDIR_FULL[&quot;sickkids&quot;]</span>
<span class="sd">    hparams : dict, optional</span>
<span class="sd">        Keyword arguments for experiment hyperparameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        For each frame in the sequence and for each side, contains</span>
<span class="sd">            - prediction for each image,</span>
<span class="sd">            - probability of each prediction,</span>
<span class="sd">            - raw model output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set to evaluation mode</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="c1"># Predict on each images one-by-one</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">filename</span> <span class="k">if</span> <span class="n">img_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">img_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Load image as expected by model</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">read_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">ImageReadMode</span><span class="o">.</span><span class="n">RGB</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Convert to tensor and send to device</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

    <span class="c1"># Perform inference to get both side/plane raw output</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

    <span class="c1"># Accumulate prediction, probability and raw output for each label</span>
    <span class="n">label_to_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">label_part</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">[</span><span class="n">label_part</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># Get probability</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># Get maximum activation</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># Get mapping of index to class</span>
        <span class="n">idx_to_class</span> <span class="o">=</span> \
            <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_PART_TO_CLASSES</span><span class="p">[</span><span class="n">label_part</span><span class="p">][</span><span class="s2">&quot;idx_to_class&quot;</span><span class="p">]</span>

        <span class="c1"># Convert from encoded label to label name</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">idx_to_class</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)(</span><span class="n">preds</span><span class="p">)</span>

        <span class="c1"># Store results</span>
        <span class="n">label_to_results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_part</span><span class="si">}</span><span class="s2">_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outs</span>
        <span class="n">label_to_results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_part</span><span class="si">}</span><span class="s2">_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs</span>
        <span class="n">label_to_results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_part</span><span class="si">}</span><span class="s2">_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">label_to_results</span><span class="p">)</span></div>



<span class="c1">################################################################################</span>
<span class="c1">#                            Analysis of Inference                             #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="plot_confusion_matrix">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.plot_confusion_matrix">[docs]</a>
<span class="k">def</span> <span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">filter_confident</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">hparams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot confusion matrix based on model predictions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions and labels. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    filter_confident : bool, optional</span>
<span class="sd">        If True, filters for most confident prediction in each view label for</span>
<span class="sd">        each unique sequence, before creating the confusion matrix.</span>
<span class="sd">    ax : matplotlib.Axis, optional</span>
<span class="sd">        Axis to plot confusion matrix on</span>
<span class="sd">    hparams : dict, optional</span>
<span class="sd">        Keyword arguments for experiment hyperparameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If flagged, get for most confident pred. for each view label per seq.</span>
    <span class="k">if</span> <span class="n">filter_confident</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">filter_most_confident</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>

    <span class="c1"># Gets all labels</span>
    <span class="k">if</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative_side&quot;</span><span class="p">):</span>
        <span class="n">all_labels</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">CLASSES</span><span class="p">[</span><span class="s2">&quot;relative&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_part</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_part&quot;</span><span class="p">)</span>
        <span class="n">all_labels</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_PART_TO_CLASSES</span><span class="p">[</span><span class="n">label_part</span><span class="p">][</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span>

    <span class="c1"># Plots confusion matrix</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">skmetrics</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">],</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="n">all_labels</span><span class="p">)</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="n">skmetrics</span><span class="o">.</span><span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">display_labels</span><span class="o">=</span><span class="n">all_labels</span><span class="p">)</span>
    <span class="n">disp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># Set title</span>
    <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Confusion Matrix (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s2">&quot;Most Confident&quot;</span> <span class="k">if</span> <span class="n">filter_confident</span> <span class="k">else</span> <span class="s2">&quot;All&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span></div>



<div class="viewcode-block" id="print_confusion_matrix">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.print_confusion_matrix">[docs]</a>
<span class="k">def</span> <span class="nf">print_confusion_matrix</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="o">**</span><span class="n">hparams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints confusion matrix with proportion and count</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions and labels. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    hparams : dict, optional</span>
<span class="sd">        Keyword arguments for experiment hyperparameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_counts_and_prop</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given all instances for one label, get the proportions and counts for</span>
<span class="sd">        each of the predicted labels.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            Model prediction for 1 label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_counts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">num_samples</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Gets all labels</span>
    <span class="k">if</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative_side&quot;</span><span class="p">):</span>
        <span class="n">all_labels</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">CLASSES</span><span class="p">[</span><span class="s2">&quot;relative&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_part</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_part&quot;</span><span class="p">)</span>
        <span class="n">all_labels</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_PART_TO_CLASSES</span><span class="p">[</span><span class="n">label_part</span><span class="p">][</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span>

    <span class="c1"># Check that all labels are found</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_labels</span><span class="p">),</span> \
        <span class="s2">&quot;Not all given labels are present!&quot;</span>

    <span class="c1"># Accumulate counts and proportion of predicted labels for each label</span>
    <span class="n">df_labels</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_counts_and_prop</span><span class="p">)</span>

    <span class="c1"># Rename columns</span>
    <span class="n">df_labels</span> <span class="o">=</span> <span class="n">df_labels</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="s2">&quot;proportion&quot;</span><span class="p">,</span> <span class="s2">&quot;level_1&quot;</span><span class="p">:</span> <span class="s2">&quot;pred&quot;</span><span class="p">})</span>

    <span class="c1"># Reformat table to become a confusion matrix</span>
    <span class="n">df_cm</span> <span class="o">=</span> <span class="n">df_labels</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;proportion&quot;</span><span class="p">)</span>

    <span class="c1"># Remove axis names</span>
    <span class="n">df_cm</span> <span class="o">=</span> <span class="n">df_cm</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Fill in columns, if not predicted (at all)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">all_labels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_cm</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_cm</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.0 (0)&quot;</span>

    <span class="c1"># Reorder column and index by given labels</span>
    <span class="n">df_cm</span> <span class="o">=</span> <span class="n">df_cm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">all_labels</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)</span>

    <span class="n">viz_utils</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span><span class="n">df_cm</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_pred_probability_by_views">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.plot_pred_probability_by_views">[docs]</a>
<span class="k">def</span> <span class="nf">plot_pred_probability_by_views</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">relative_side</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot average probability of prediction per view label.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    relative_side : bool, optional</span>
<span class="sd">        If True, assumes predicted labels are encoded for relative sides, by</span>
<span class="sd">        default False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Filter for correct predictions</span>
    <span class="n">df_pred</span><span class="o">.</span><span class="n">binary_label</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Bladder&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;Bladder&quot;</span> <span class="k">else</span> <span class="s2">&quot;Other&quot;</span><span class="p">)</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">binary_label</span> <span class="o">==</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">pred</span><span class="p">]</span>

    <span class="c1"># Average prediction probability over each view</span>
    <span class="n">df_prob_by_view</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_prob_by_view</span> <span class="o">=</span> <span class="n">df_prob_by_view</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
        <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;View&quot;</span><span class="p">,</span> <span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="s2">&quot;Probability&quot;</span><span class="p">})</span>

    <span class="c1"># Gets all labels based on side encoding</span>
    <span class="n">all_labels</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">CLASSES</span><span class="p">[</span><span class="s2">&quot;relative&quot;</span> <span class="k">if</span> <span class="n">relative_side</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="c1"># Bar plot</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_prob_by_view</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;View&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Probability&quot;</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="n">all_labels</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="check_misclassifications">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.check_misclassifications">[docs]</a>
<span class="k">def</span> <span class="nf">check_misclassifications</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">relative_side</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the most confident model predictions, determine the percentage of</span>
<span class="sd">    misclassifications that are due to:</span>
<span class="sd">        1. Swapping sides (e.g., Saggital Right mistaken for Saggital Left)</span>
<span class="sd">        2. Adjacent views</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    filter : bool, optional</span>
<span class="sd">        If True, filters for most confident prediction in consecutive label</span>
<span class="sd">        groups or for each of the 5 main views per sequence, by default True.</span>
<span class="sd">    local : bool, optional</span>
<span class="sd">        If True, gets the most confident prediction within each group of</span>
<span class="sd">        consecutive images with the same label. Otherwise, aggregates by view</span>
<span class="sd">        label to find the most confident view label predictions,</span>
<span class="sd">        by default True.</span>
<span class="sd">    relative_side : bool, optional</span>
<span class="sd">        If True, assumes predicted labels are encoded for relative sides, by</span>
<span class="sd">        default False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filter for most confident predictions for each expected view label</span>
    <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">filter_most_confident</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="n">local</span><span class="p">)</span>

    <span class="c1"># Get misclassified instances</span>
    <span class="n">df_misclassified</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">pred</span><span class="p">)]</span>

    <span class="c1"># Get label adjacency dict based on side label</span>
    <span class="n">label_adjacency_dict</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_ADJACENCY</span><span class="p">[</span><span class="s2">&quot;relative&quot;</span> <span class="k">if</span> \
        <span class="n">relative_side</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

    <span class="c1"># 1. Proportion and count of misclassification from adjacent views</span>
    <span class="n">prop_adjacent</span> <span class="o">=</span> <span class="n">df_misclassified</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">pred</span> <span class="ow">in</span> <span class="n">label_adjacency_dict</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">label</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">num_adjacent</span> <span class="o">=</span> <span class="n">df_misclassified</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">pred</span> <span class="ow">in</span> <span class="n">label_adjacency_dict</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">label</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># 2. Proportion and count of misclassification from wrong body side</span>
    <span class="c1"># Filter out Bladder images (so remains are Sagittal/Transverse labels/pred)</span>
    <span class="n">df_swapped</span> <span class="o">=</span> <span class="n">df_misclassified</span><span class="p">[(</span><span class="n">df_misclassified</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s2">&quot;Bladder&quot;</span><span class="p">)]</span>
    <span class="n">df_swapped</span> <span class="o">=</span> <span class="n">df_swapped</span><span class="p">[(</span><span class="n">df_swapped</span><span class="o">.</span><span class="n">pred</span> <span class="o">!=</span> <span class="s2">&quot;Bladder&quot;</span><span class="p">)]</span>
    <span class="n">prop_swapped</span> <span class="o">=</span> <span class="n">df_swapped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">num_swapped</span> <span class="o">=</span> <span class="n">df_swapped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Format output</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
        <span class="s2">&quot;Wrong Side&quot;</span><span class="p">:</span> <span class="n">prop_swapped</span><span class="p">,</span>
        <span class="s2">&quot;Adjacent Label&quot;</span><span class="p">:</span> <span class="n">prop_adjacent</span><span class="p">,</span>
        <span class="s2">&quot;Other&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">prop_swapped</span> <span class="o">+</span> <span class="n">prop_adjacent</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;Proportion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">prop_swapped</span><span class="p">,</span> <span class="n">prop_adjacent</span><span class="p">,</span>
                       <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">prop_swapped</span><span class="o">+</span><span class="n">prop_adjacent</span><span class="p">)],</span>
        <span class="s2">&quot;Count&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">num_swapped</span><span class="p">,</span> <span class="n">num_adjacent</span><span class="p">,</span>
                  <span class="nb">len</span><span class="p">(</span><span class="n">df_misclassified</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_swapped</span> <span class="o">-</span> <span class="n">num_adjacent</span><span class="p">]</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Wrong Side&quot;</span><span class="p">,</span> <span class="s2">&quot;Adjacent Label&quot;</span><span class="p">,</span> <span class="s2">&quot;Other&quot;</span><span class="p">])</span>

    <span class="c1"># Print to command line</span>
    <span class="n">viz_utils</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span><span class="n">df_results</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_prob_over_sequence">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.plot_prob_over_sequence">[docs]</a>
<span class="k">def</span> <span class="nf">plot_prob_over_sequence</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">correct_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_seq_num</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots average probability of prediction over each number in the sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    correct_only : bool, optional</span>
<span class="sd">        If True, filters for correctly predicted samples before plotting, by</span>
<span class="sd">        default False.</span>
<span class="sd">    update_seq_num : bool, optional</span>
<span class="sd">        If True, accounts for missing images between sequence numbers by</span>
<span class="sd">        creating new (raw) sequence number based on existing images, by default</span>
<span class="sd">        False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;seq_number&quot;</span>

    <span class="c1"># If specified, create new sequence numbers</span>
    <span class="k">if</span> <span class="n">update_seq_num</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">get_new_seq_numbers</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;seq_number_new&quot;</span>

    <span class="c1"># Filter correct if specified</span>
    <span class="k">if</span> <span class="n">correct_only</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">pred</span><span class="p">]</span>

    <span class="c1"># Create plot</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">])[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;prob&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number in the US Sequence&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Prediction Probability&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_acc_over_sequence">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.plot_acc_over_sequence">[docs]</a>
<span class="k">def</span> <span class="nf">plot_acc_over_sequence</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">update_seq_num</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots accuracy of predictions over each number in the sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    update_seq_num : bool, optional</span>
<span class="sd">        If True, accounts for missing images between sequence numbers by</span>
<span class="sd">        creating new (raw) sequence number based on existing images, by default</span>
<span class="sd">        False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;seq_number&quot;</span>

    <span class="c1"># If specified, create new sequence numbers</span>
    <span class="k">if</span> <span class="n">update_seq_num</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">get_new_seq_numbers</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;seq_number_new&quot;</span>

    <span class="c1"># Create plot</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pred</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">df</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;accuracy&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number in the US Sequence&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_image_count_over_sequence">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.plot_image_count_over_sequence">[docs]</a>
<span class="k">def</span> <span class="nf">plot_image_count_over_sequence</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">update_seq_num</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots number of imgaes for each number in the sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;seq_number&quot;</span>

    <span class="c1"># If specified, create new sequence numbers</span>
    <span class="k">if</span> <span class="n">update_seq_num</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">get_new_seq_numbers</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;seq_number_new&quot;</span>

    <span class="c1"># Create plot</span>
    <span class="n">df_count</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    <span class="n">df_count</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>
    <span class="n">df_count</span> <span class="o">=</span> <span class="n">df_count</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_count</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number in the US Sequence&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Number of Images&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="check_others_pred_progression">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.check_others_pred_progression">[docs]</a>
<span class="k">def</span> <span class="nf">check_others_pred_progression</span><span class="p">(</span><span class="n">df_pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given model predictions for full sequences that include &quot;Other&quot; labels,</span>
<span class="sd">    show (predicted) label progression for unlabeled images among real labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_get_label_sequence</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a unique US sequence for one patient, get the order of contiguous</span>
<span class="sd">        labels in the sequence, where there is blocks of unlabeled image, show</span>
<span class="sd">        progression of predicted labels.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            One full US sequence for one patient.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Unique label section within the sequence provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label_views</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;seq_number&quot;</span><span class="p">])[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">pred_views</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;seq_number&quot;</span><span class="p">])[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Encoded label for &quot;Other&quot;</span>
        <span class="n">other_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">CLASS_TO_IDX</span><span class="p">[</span><span class="s2">&quot;Other&quot;</span><span class="p">])</span>

        <span class="c1"># Keep track of order of views</span>
        <span class="n">prev_label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_pred</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_views</span><span class="p">):</span>
            <span class="c1"># If not &#39;Other&#39;, show regular label progression</span>
            <span class="k">if</span> <span class="n">view</span> <span class="o">!=</span> <span class="n">other_label</span> <span class="ow">and</span> <span class="n">view</span> <span class="o">!=</span> <span class="n">prev_label</span><span class="p">:</span>
                <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
                <span class="n">prev_pred</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># If &#39;Other&#39;, show prediction progression until out of &#39;Other&#39;</span>
            <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="n">other_label</span> <span class="ow">and</span> <span class="n">pred_views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">prev_pred</span><span class="p">:</span>
                <span class="n">prev_pred</span> <span class="o">=</span> <span class="n">pred_views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># Color predicted view, so it&#39;s distinguishable in stdout</span>
                <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">MAGENTA</span><span class="si">}{</span><span class="n">prev_pred</span><span class="si">}{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">prev_label</span> <span class="o">=</span> <span class="n">view</span>
        <span class="k">return</span> <span class="n">seq</span>

    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Encode labels as integers</span>
    <span class="n">df_pred</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">CLASS_TO_IDX</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df_pred</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">CLASS_TO_IDX</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="c1"># Get unique label sequences per patient</span>
    <span class="n">df_seqs</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span>
    <span class="n">label_seqs</span> <span class="o">=</span> <span class="n">df_seqs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_get_label_sequence</span><span class="p">)</span>
    <span class="n">label_seqs</span> <span class="o">=</span> <span class="n">label_seqs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">label_seq_counts</span> <span class="o">=</span> <span class="n">label_seqs</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Label Sequence&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Count&quot;</span><span class="p">})</span>

    <span class="c1"># Print to stdout</span>
    <span class="n">viz_utils</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span><span class="n">label_seq_counts</span><span class="p">,</span> <span class="n">show_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_rel_side_pred_progression">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.check_rel_side_pred_progression">[docs]</a>
<span class="k">def</span> <span class="nf">check_rel_side_pred_progression</span><span class="p">(</span><span class="n">df_pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given model predictions for full sequences where side labels are relative</span>
<span class="sd">    to the first side, show label/predicted label progression.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Highlight locations where error in toggling between first/second occurs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_get_label_sequence</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a unique US sequence for one patient, get the order of contiguous</span>
<span class="sd">        correct/incorrect relative side labels in the sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            One full US sequence for one patient.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Unique label section within the sequence provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get true/predicted (relative) side label</span>
        <span class="n">side_labels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;seq_number&quot;</span><span class="p">])[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">side_preds</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;seq_number&quot;</span><span class="p">])[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="c1"># Keep track of order of views</span>
        <span class="n">prev_label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_pred</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">side_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">side_labels</span><span class="p">):</span>
            <span class="c1"># Get prediction</span>
            <span class="n">side_pred</span> <span class="o">=</span> <span class="n">side_preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># If side changed</span>
            <span class="k">if</span> <span class="n">side_label</span> <span class="o">!=</span> <span class="n">prev_label</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">side_pred</span> <span class="o">==</span> <span class="n">side_label</span><span class="p">:</span>
                    <span class="c1"># If side changed + correct pred., color green</span>
                    <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">side_label</span><span class="si">}{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Reset prev. prediction (in case new error pops up)</span>
                    <span class="n">prev_pred</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">side_pred</span> <span class="o">!=</span> <span class="n">prev_pred</span><span class="p">:</span>
                    <span class="c1"># If side changed + new incorrect pred., color yellow</span>
                    <span class="n">prev_pred</span> <span class="o">=</span> <span class="n">side_pred</span>
                    <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">prev_pred</span><span class="si">}{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">side_pred</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">side_label</span><span class="p">,</span> <span class="n">prev_pred</span><span class="p">):</span>
                    <span class="c1"># If side same + new incorrect pred., color red</span>
                    <span class="n">prev_pred</span> <span class="o">=</span> <span class="n">side_pred</span>
                    <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">MAGENTA</span><span class="si">}{</span><span class="n">prev_pred</span><span class="si">}{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">prev_label</span> <span class="o">=</span> <span class="n">side_label</span>
        <span class="k">return</span> <span class="n">seq</span>

    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Extract and encode relative side labels</span>
    <span class="n">side_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;First&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;Second&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,}</span>
    <span class="n">df_pred</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">side_to_idx</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">extract_from_label</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df_pred</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">side_to_idx</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">extract_from_label</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="c1"># Get unique label sequences per patient</span>
    <span class="n">df_seqs</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span>
    <span class="n">label_seqs</span> <span class="o">=</span> <span class="n">df_seqs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_get_label_sequence</span><span class="p">)</span>
    <span class="n">label_seqs</span> <span class="o">=</span> <span class="n">label_seqs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">label_seq_counts</span> <span class="o">=</span> <span class="n">label_seqs</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Label Sequence&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Count&quot;</span><span class="p">})</span>

    <span class="c1"># Print to stdout</span>
    <span class="n">viz_utils</span><span class="o">.</span><span class="n">print_table</span><span class="p">(</span><span class="n">label_seq_counts</span><span class="p">,</span> <span class="n">show_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="compare_prediction_similarity">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.compare_prediction_similarity">[docs]</a>
<span class="k">def</span> <span class="nf">compare_prediction_similarity</span><span class="p">(</span><span class="n">df_pred_1</span><span class="p">,</span> <span class="n">df_pred_2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each label, print Pearson correlation of:</span>
<span class="sd">        (1) predicted label with model 1 vs model 2</span>
<span class="sd">        (2) side predicted</span>
<span class="sd">        (3) view predicted</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred_1 : pandas.DataFrame</span>
<span class="sd">        Inference on the same dset by model 1</span>
<span class="sd">    df_pred_2 : pandas.DataFrame</span>
<span class="sd">        Inference on the same dset by model 2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Correlation of exact label</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">################################################################################</span>
<span class="s2">#                         Exact Prediction Correlation                         #</span>
<span class="s2">################################################################################</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">df_pred_1</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">pred_mask_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_pred_1</span><span class="o">.</span><span class="n">pred</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">pred_mask_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_pred_2</span><span class="o">.</span><span class="n">pred</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">pred_mask_1</span><span class="p">,</span><span class="w"> </span><span class="n">pred_mask_2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract side and plane (view) from predicted label</span>
    <span class="n">extract_from_label</span><span class="p">(</span><span class="n">df_pred_1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="n">extract</span><span class="o">=</span><span class="s2">&quot;side&quot;</span><span class="p">)</span>
    <span class="n">extract_from_label</span><span class="p">(</span><span class="n">df_pred_1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="n">extract</span><span class="o">=</span><span class="s2">&quot;plane&quot;</span><span class="p">)</span>
    <span class="n">extract_from_label</span><span class="p">(</span><span class="n">df_pred_2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="n">extract</span><span class="o">=</span><span class="s2">&quot;side&quot;</span><span class="p">)</span>
    <span class="n">extract_from_label</span><span class="p">(</span><span class="n">df_pred_2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="n">extract</span><span class="o">=</span><span class="s2">&quot;plane&quot;</span><span class="p">)</span>

    <span class="c1"># Correlation of side</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">################################################################################</span>
<span class="s2">#                          Side Predicted Correlation                          #</span>
<span class="s2">################################################################################</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Left&quot;</span><span class="p">,</span> <span class="s2">&quot;Right&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">):</span>
        <span class="n">pred_mask_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_pred_1</span><span class="o">.</span><span class="n">pred_side</span> <span class="o">==</span> <span class="n">side</span><span class="p">)</span>
        <span class="n">pred_mask_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_pred_2</span><span class="o">.</span><span class="n">pred_side</span> <span class="o">==</span> <span class="n">side</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">side</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">pred_mask_1</span><span class="p">,</span><span class="w"> </span><span class="n">pred_mask_2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Correlation of view</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">################################################################################</span>
<span class="s2">#                         Plane Predicted Correlation                          #</span>
<span class="s2">################################################################################</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Saggital&quot;</span><span class="p">,</span> <span class="s2">&quot;Transverse&quot;</span><span class="p">,</span> <span class="s2">&quot;Bladder&quot;</span><span class="p">):</span>
        <span class="n">pred_mask_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_pred_1</span><span class="o">.</span><span class="n">pred_plane</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)</span>
        <span class="n">pred_mask_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_pred_2</span><span class="o">.</span><span class="n">pred_plane</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">pred_mask_1</span><span class="p">,</span><span class="w"> </span><span class="n">pred_mask_2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_rolling_accuracy">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.plot_rolling_accuracy">[docs]</a>
<span class="k">def</span> <span class="nf">plot_rolling_accuracy</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">max_seq_num</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span>
                          <span class="n">update_seq_num</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given predictions on ultrasound image sequences, plot accuracy on</span>
<span class="sd">    overlapping windows of size `window_size`, based on sequence number.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Windows are done on sequence numbers (e.g., sequence numbers [0-14])</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    window_size : int, optional</span>
<span class="sd">        Window size for sequence numbers, by default 15</span>
<span class="sd">    max_seq_num : int, optional</span>
<span class="sd">        Maximum sequence number to consider, by default 75</span>
<span class="sd">    update_seq_num : bool, optional</span>
<span class="sd">        If True, accounts for missing images between sequence numbers by</span>
<span class="sd">        creating new (raw) sequence number based on existing images, by default</span>
<span class="sd">        False.</span>
<span class="sd">    save_path : str, optional</span>
<span class="sd">        If provided, saves figure to path, by default None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.axes.Axes</span>
<span class="sd">        Axis plot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seq_num_col</span> <span class="o">=</span> <span class="s2">&quot;seq_number&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">update_seq_num</span> <span class="k">else</span> <span class="s2">&quot;seq_number_new&quot;</span>
    <span class="c1"># If specified, update sequence numbers to relative sequence numbers</span>
    <span class="k">if</span> <span class="n">update_seq_num</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">get_new_seq_numbers</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>

    <span class="c1"># Specify maximum sequencec number</span>
    <span class="n">true_max_seq_num</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">seq_num_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">max_seq_num</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_seq_num</span><span class="p">,</span> <span class="n">true_max_seq_num</span><span class="p">)</span>

    <span class="c1"># Calculate accuracies of windows</span>
    <span class="n">window_accs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sample_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_seq_num</span><span class="o">-</span><span class="n">window_size</span><span class="p">):</span>
        <span class="n">df_window</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">seq_num_col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">seq_num_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">+</span><span class="n">window_size</span><span class="p">)]</span>
        <span class="n">window_accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">df_window</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">df_window</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">sample_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_window</span><span class="p">))</span>

    <span class="c1"># Create bar plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">window_accs</span><span class="p">))),</span> <span class="n">window_accs</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#377eb8&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="c1"># Add number of samples (used to calculate accuracy) as bar labels</span>
    <span class="n">bar_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;N:</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span>
                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">)]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar_label</span><span class="p">(</span><span class="n">container</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">bar_labels</span><span class="p">,</span>
                    <span class="n">label_type</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                    <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set y bounds</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add axis text</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Starting Sequence Number&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Rolling Accuracy over Sequence Number Windows of &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Size </span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Save figure if specified</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span></div>



<div class="viewcode-block" id="calculate_metrics">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.calculate_metrics">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">ci_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate important metrics given prediction and labels</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pd.DataFrame</span>
<span class="sd">        Model predictions and labels</span>
<span class="sd">    ci : bool, optional</span>
<span class="sd">        If True, add bootstrapped confidence interval, by default False.</span>
<span class="sd">    **ci_kwargs : dict, optional</span>
<span class="sd">        Keyword arguments to pass into `bootstrap_metric` if `ci` is True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Table containing metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Accumulate exact metric, and confidence interval bounds (if specified)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="c1"># 1. Accuracy by class</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
        <span class="n">df_pred_filtered</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Label Accuracy (</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df_pred_filtered</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Label Accuracy (</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_and_round</span><span class="p">(</span><span class="n">calculate_accuracy</span><span class="p">(</span>
                <span class="n">df_pred_filtered</span><span class="p">))</span>

    <span class="c1"># 2. Overall accuracy</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;Overall Accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_and_round</span><span class="p">(</span><span class="n">calculate_accuracy</span><span class="p">(</span><span class="n">df_pred</span><span class="p">))</span>
    <span class="c1"># Bootstrap confidence interval</span>
    <span class="k">if</span> <span class="n">ci</span><span class="p">:</span>
        <span class="n">point</span><span class="p">,</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span> <span class="o">=</span> <span class="n">bootstrap_metric</span><span class="p">(</span>
            <span class="n">df_pred</span><span class="o">=</span><span class="n">df_pred</span><span class="p">,</span>
            <span class="n">metric_func</span><span class="o">=</span><span class="n">skmetrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">,</span>
            <span class="o">**</span><span class="n">ci_kwargs</span><span class="p">)</span>
        <span class="n">point</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">scale_and_round</span><span class="p">(</span><span class="n">point</span><span class="p">),</span> <span class="n">scale_and_round</span><span class="p">(</span><span class="n">lower</span><span class="p">),</span> <span class="n">scale_and_round</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;Overall Accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">point</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">lower</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">upper</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="c1"># 3. Accuracy, grouped by patient</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;Accuracy (By Patient)&quot;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">calculate_metric_by_groups</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="c1"># 4. Accuracy, grouped by sequence</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;Accuracy (By Seq)&quot;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">calculate_metric_by_groups</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span>

    <span class="c1"># 5. Accuracy for adjacent same-label images vs. stand-alone images</span>
    <span class="n">mask_same_label_adjacent</span> <span class="o">=</span> <span class="n">identify_repeating_same_label_in_video</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;Accuracy (Adjacent to Same-Label)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_and_round</span><span class="p">(</span><span class="n">calculate_accuracy</span><span class="p">(</span>
        <span class="n">df_pred</span><span class="p">[</span><span class="n">mask_same_label_adjacent</span><span class="p">]))</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;Accuracy (Not Adjacent to Same-Label)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_and_round</span><span class="p">(</span><span class="n">calculate_accuracy</span><span class="p">(</span>
        <span class="n">df_pred</span><span class="p">[</span><span class="o">~</span><span class="n">mask_same_label_adjacent</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_same_label_adjacent</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">[]]))</span>

    <span class="c1"># 6. F1 Score by class</span>
    <span class="c1"># NOTE: Overall F1 Score isn&#39;t calculated because it&#39;s equal to</span>
    <span class="c1">#       Overall Accuracy in multi-label problems.</span>
    <span class="c1"># TODO: Implement wrapper function to allow bootstrapping f1_score</span>
    <span class="n">f1_scores</span> <span class="o">=</span> <span class="n">skmetrics</span><span class="o">.</span><span class="n">f1_score</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">],</span>
                                   <span class="n">labels</span><span class="o">=</span><span class="n">unique_labels</span><span class="p">,</span>
                                   <span class="n">average</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f1_score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f1_scores</span><span class="p">):</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Label F1-Score (</span><span class="si">{</span><span class="n">unique_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">f1_score</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_metric_by_groups">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.calculate_metric_by_groups">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_metric_by_groups</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">,</span>
                               <span class="n">metric_func</span><span class="o">=</span><span class="n">skmetrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Group predictions by patient/sequence ID, calculate metric on each group</span>
<span class="sd">    and get the average prediction</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pd.DataFrame</span>
<span class="sd">        Model predictions and labels</span>
<span class="sd">    group_cols : list</span>
<span class="sd">        List of columns in `df_pred` to group by</span>
<span class="sd">    metric_func : function, optional</span>
<span class="sd">        Reference to function that can be used to calculate a metric given the</span>
<span class="sd">        (label, predictions), by default sklearn.metrics.accuracy_score</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Contains mean and standard deviation of calculated metric across groups</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Skip, if empty</span>
    <span class="k">if</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>

    <span class="c1"># Calculate metric on each group</span>
    <span class="n">grp_metrics</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">group_cols</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">df_grp</span><span class="p">:</span> <span class="n">metric_func</span><span class="p">(</span><span class="n">df_grp</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="n">df_grp</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]))</span>

    <span class="c1"># Calculate average across groups</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">grp_metrics</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">grp_metrics</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mean</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">sd</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="calculate_hn_corr">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.calculate_hn_corr">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_hn_corr</span><span class="p">(</span><span class="n">df_pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute correlation between correct predictions and HN</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Correlation between correctly predicted label and HN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filter for samples with HN label</span>
    <span class="n">df_hn</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hn&quot;</span><span class="p">])</span>
    <span class="n">df_hn</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_hn</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">df_hn</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">df_hn</span><span class="p">[</span><span class="s2">&quot;hn&quot;</span><span class="p">],</span> <span class="n">df_hn</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="bootstrap_metric">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.bootstrap_metric">[docs]</a>
<span class="k">def</span> <span class="nf">bootstrap_metric</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span>
                     <span class="n">metric_func</span><span class="o">=</span><span class="n">skmetrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">,</span>
                     <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">pred_col</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                     <span class="n">n_bootstrap</span><span class="o">=</span><span class="mi">12000</span><span class="p">,</span>
                     <span class="n">seed</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">SEED</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform BCa bootstrap on table of predictions to calculate metric with a</span>
<span class="sd">    bootstrapped confidence interval.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    metric_func : function, optional</span>
<span class="sd">        Reference to function that can be used to calculate a metric given the</span>
<span class="sd">        (label, predictions), by default sklearn.metrics.accuracy_score</span>
<span class="sd">    label_col : str, optional</span>
<span class="sd">        Name of label column, by default &quot;label&quot;</span>
<span class="sd">    pred_col : str, optional</span>
<span class="sd">        Name of label column, by default &quot;pred&quot;</span>
<span class="sd">    alpha : float, optional</span>
<span class="sd">        Desired significance level, by default 0.05</span>
<span class="sd">    n_bootstrap : int, optional</span>
<span class="sd">        Sample size for each bootstrap iteration</span>
<span class="sd">    seed : int, optional</span>
<span class="sd">        Random seed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of (exact, (lower_bound, upper_bound))</span>
<span class="sd">        Output of `func` with 95% confidence interval ends</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate exact point metric</span>
    <span class="c1"># NOTE: Assumes function takes in (label, pred)</span>
    <span class="n">exact_metric</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">metric_func</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">label_col</span><span class="p">],</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">pred_col</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Initialize bootstrap</span>
    <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">IIDBootstrap</span><span class="p">(</span>
        <span class="n">df_pred</span><span class="p">[</span><span class="n">label_col</span><span class="p">],</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">pred_col</span><span class="p">],</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Calculate empirical CI bounds</span>
        <span class="n">ci_bounds</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span>
            <span class="n">func</span><span class="o">=</span><span class="n">metric_func</span><span class="p">,</span>
            <span class="n">reps</span><span class="o">=</span><span class="n">n_bootstrap</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bca&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">tail</span><span class="o">=</span><span class="s1">&#39;two&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="c1"># Round to 4 decimal places</span>
        <span class="n">ci_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ci_bounds</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span> <span class="c1"># NOTE: May occur if all labels are predicted correctly</span>
        <span class="n">ci_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">exact_metric</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ci_bounds</span><span class="p">)</span></div>



<div class="viewcode-block" id="eval_calculate_all_metrics">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.eval_calculate_all_metrics">[docs]</a>
<span class="k">def</span> <span class="nf">eval_calculate_all_metrics</span><span class="p">(</span><span class="n">df_pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates all eval. metrics in a proper table format</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Table of formatted metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Accumulate metric table columns</span>
    <span class="n">accum_metric_tables</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 1. Calculate metrics</span>
    <span class="c1"># 1.1.1 For all samples</span>
    <span class="n">df_metrics_all</span> <span class="o">=</span> <span class="n">calculate_metrics</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_metrics_all</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;All&quot;</span>
    <span class="n">accum_metric_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_metrics_all</span><span class="p">)</span>

    <span class="c1"># 0. Filler columns</span>
    <span class="n">filler</span> <span class="o">=</span> <span class="n">df_metrics_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">filler</span><span class="p">[:]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">filler</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># 1.2 Stratify patients w/ HN and w/o HN</span>
    <span class="k">if</span> <span class="s2">&quot;hn&quot;</span> <span class="ow">in</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_metrics_w_hn</span> <span class="o">=</span> <span class="n">calculate_metrics</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">hn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">df_metrics_w_hn</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;With HN&quot;</span>
        <span class="n">df_metrics_wo_hn</span> <span class="o">=</span> <span class="n">calculate_metrics</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">hn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">df_metrics_wo_hn</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Without HN&quot;</span>

        <span class="c1"># Update accumulator</span>
        <span class="n">accum_metric_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filler</span><span class="p">)</span>
        <span class="n">accum_metric_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_metrics_w_hn</span><span class="p">)</span>
        <span class="n">accum_metric_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_metrics_wo_hn</span><span class="p">)</span>

    <span class="c1"># 1.3 For images at label boundaries</span>
    <span class="c1"># NOTE: Disabled for now</span>
    <span class="c1"># df_metrics_at_boundary = calculate_metrics(</span>
    <span class="c1">#     df_pred[df_pred[&quot;at_label_boundary&quot;]])</span>
    <span class="c1"># df_metrics_at_boundary.name = &quot;At Label Boundary&quot;</span>

    <span class="c1"># 1.4 Most confident sample for each predicted view label across sequence</span>
    <span class="n">df_confident</span> <span class="o">=</span> <span class="n">filter_most_confident</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df_metrics_confident</span> <span class="o">=</span> <span class="n">calculate_metrics</span><span class="p">(</span><span class="n">df_confident</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_metrics_confident</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Most Confident&quot;</span>
    <span class="n">accum_metric_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_metrics_confident</span><span class="p">)</span>

    <span class="c1"># 1.5 If bladder present, re-compute metrics without Bladder images</span>
    <span class="c1"># NOTE: Doesn&#39;t remove non-Bladder images misclassified as Bladder</span>
    <span class="k">for</span> <span class="n">bladder_label</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;Bladder&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">bladder_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="c1"># Recalculate metrics</span>
        <span class="n">df_pred_wo_bladder</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">bladder_label</span><span class="p">]</span>
        <span class="n">df_metrics_wo_bladder</span> <span class="o">=</span> <span class="n">calculate_metrics</span><span class="p">(</span><span class="n">df_pred_wo_bladder</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_metrics_wo_bladder</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Without Bladder&quot;</span>

        <span class="c1"># Update accumulator</span>
        <span class="n">accum_metric_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filler</span><span class="p">)</span>
        <span class="n">accum_metric_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_metrics_wo_bladder</span><span class="p">)</span>

    <span class="c1"># 2. Combine</span>
    <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">accum_metric_tables</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_metrics</span></div>



<div class="viewcode-block" id="eval_create_plots">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.eval_create_plots">[docs]</a>
<span class="k">def</span> <span class="nf">eval_create_plots</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">hparams</span><span class="p">,</span> <span class="n">inference_dir</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span>
                      <span class="n">comet_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visual evaluation of model performance</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    hparams : dict</span>
<span class="sd">        Keyword arguments for experiment hyperparameters</span>
<span class="sd">    inference_dir : str</span>
<span class="sd">        Path to experiment-specific inference directory</span>
<span class="sd">    dset : str, optional</span>
<span class="sd">        Name of dataset</span>
<span class="sd">    split : str, optional</span>
<span class="sd">        Specific split of dataset. One of (train/val/test)</span>
<span class="sd">    comet_logger : comet_ml.ExistingExperiment</span>
<span class="sd">        If provided, log figures to Comet ML</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 0. Reset theme</span>
    <span class="n">viz_utils</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">THEME</span><span class="p">)</span>

    <span class="c1"># 1. Create confusion matrix plot</span>
    <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="c1"># 1.1 Plot confusion matrix for most confident predictions</span>
    <span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">filter_confident</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="o">**</span><span class="n">hparams</span><span class="p">)</span>
    <span class="c1"># 1.2 Plot confusion matrix for all predictions</span>
    <span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">filter_confident</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="o">**</span><span class="n">hparams</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inference_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_confusion_matrix.png&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">comet_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comet_logger</span><span class="o">.</span><span class="n">log_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_confusion_matrix.png&quot;</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">(),</span>
                                <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 1.3 Print confusion matrix for all predictions</span>
    <span class="c1"># NOTE: May error if the same label is predicted for all samples</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">print_confusion_matrix</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="o">**</span><span class="n">hparams</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># 2. Print reasons for misclassification of most confident predictions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_part&quot;</span><span class="p">):</span>
        <span class="n">check_misclassifications</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span>
                                 <span class="n">relative_side</span><span class="o">=</span><span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative_side&quot;</span><span class="p">))</span>

    <span class="c1"># 3. Show randomly chosen side predictions for full sequences</span>
    <span class="n">show_example_side_predictions</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span>
                                  <span class="n">relative_side</span><span class="o">=</span><span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative_side&quot;</span><span class="p">),</span>
                                  <span class="n">label_part</span><span class="o">=</span><span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_part&quot;</span><span class="p">))</span></div>



<div class="viewcode-block" id="calculate_exp_metrics">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.calculate_exp_metrics">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_exp_metrics</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">hparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">log_to_comet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given that inference was performed, compute metrics for experiment model</span>
<span class="sd">    and dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str, optional</span>
<span class="sd">        Name of dataset</span>
<span class="sd">    split : str, optional</span>
<span class="sd">        Specific split of dataset. One of (train/val/test)</span>
<span class="sd">    hparams : dict, optional</span>
<span class="sd">        Experiment hyperparameters, by default None</span>
<span class="sd">    log_to_comet : bool, optional</span>
<span class="sd">        If True, log metrics and graphs to Comet ML</span>
<span class="sd">    **infer_kwargs : Keyword arguments</span>
<span class="sd">        Inference keyword arguments, which includes</span>
<span class="sd">            mask_bladder : bool, optional</span>
<span class="sd">                If True, bladder predictions are masked out, by default False</span>
<span class="sd">            test_time_aug : bool, optional</span>
<span class="sd">                If True, perform test-time augmentation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Get experiment hyperparameters (if not provided)</span>
    <span class="n">hparams</span> <span class="o">=</span> <span class="n">hparams</span> <span class="k">if</span> <span class="n">hparams</span> \
        <span class="k">else</span> <span class="n">load_model</span><span class="o">.</span><span class="n">get_hyperparameters</span><span class="p">(</span><span class="n">exp_name</span><span class="o">=</span><span class="n">exp_name</span><span class="p">)</span>

    <span class="c1"># 1.1 Get comet logger, if specified</span>
    <span class="n">comet_logger</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">log_to_comet</span><span class="p">:</span>
        <span class="n">comet_logger</span> <span class="o">=</span> <span class="n">load_comet_logger</span><span class="p">(</span><span class="n">exp_key</span><span class="o">=</span><span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comet_exp_key&quot;</span><span class="p">))</span>

    <span class="c1"># 2. Load inference</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">load_view_predictions</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">)</span>

    <span class="c1"># If multi-output, evaluate each label part, separately</span>
    <span class="n">label_parts</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_PARTS</span> <span class="k">if</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_output&quot;</span><span class="p">)</span> \
        <span class="k">else</span> <span class="p">[</span><span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_part&quot;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">label_part</span> <span class="ow">in</span> <span class="n">label_parts</span><span class="p">:</span>
        <span class="n">temp_exp_name</span> <span class="o">=</span> <span class="n">exp_name</span>

        <span class="c1"># If multi-output, make temporary changes to hparams</span>
        <span class="n">orig_label_part</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_part&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_output&quot;</span><span class="p">):</span>
            <span class="c1"># Change experiment name to create different folders</span>
            <span class="n">temp_exp_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">label_part</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># Force to be a specific label part</span>
            <span class="n">hparams</span><span class="p">[</span><span class="s2">&quot;label_part&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_part</span>
            <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">label_part</span><span class="p">]</span>
            <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_part</span><span class="si">}</span><span class="s2">_pred&quot;</span><span class="p">]</span>
            <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_part</span><span class="si">}</span><span class="s2">_prob&quot;</span><span class="p">]</span>
            <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_part</span><span class="si">}</span><span class="s2">_out&quot;</span><span class="p">]</span>

        <span class="c1"># Experiment-specific inference directory, to store figures</span>
        <span class="n">inference_dir</span> <span class="o">=</span> <span class="n">create_save_dir_by_flags</span><span class="p">(</span>
            <span class="n">exp_name</span><span class="p">,</span>
            <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span>
            <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 4. Calculate metrics</span>
        <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">eval_calculate_all_metrics</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>
        <span class="n">df_metrics</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inference_dir</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_metrics.csv&quot;</span><span class="p">))</span>

        <span class="c1"># 4.1 Store metrics in Comet ML, if possible</span>
        <span class="k">if</span> <span class="n">comet_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;(mask_bladder)&quot;</span> <span class="k">if</span> <span class="n">infer_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_bladder&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">comet_logger</span><span class="o">.</span><span class="n">log_table</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_metrics</span><span class="si">{</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">df_metrics</span><span class="p">)</span>

        <span class="c1"># 5. Create plots for visual evaluation</span>
        <span class="n">eval_create_plots</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">hparams</span><span class="p">,</span> <span class="n">inference_dir</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>

        <span class="c1"># Revert temporary changes</span>
        <span class="n">hparams</span><span class="p">[</span><span class="s2">&quot;label_part&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_label_part</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="s2">&quot;prob&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">])</span></div>



<div class="viewcode-block" id="store_example_classifications">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.store_example_classifications">[docs]</a>
<span class="k">def</span> <span class="nf">store_example_classifications</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">mask_bladder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">save_dir</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DIR_FIGURES_PRED</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store correctly/incorrectly classified images in nested folders.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str</span>
<span class="sd">        Name of evaluation split or test dataset</span>
<span class="sd">    hparams : dict, optional</span>
<span class="sd">        Experiment hyperparameters, by default None</span>
<span class="sd">    mask_bladder : bool, optional</span>
<span class="sd">        If True, bladder predictions are masked out, by default False</span>
<span class="sd">    save_dir : str, optional</span>
<span class="sd">        Directory to save model classifications, by default</span>
<span class="sd">        constants.DIR_FIGURES_PRED</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load inference</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">create_save_path</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                                 <span class="n">mask_bladder</span><span class="o">=</span><span class="n">mask_bladder</span><span class="p">)</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

    <span class="c1"># Sort by video</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_number&quot;</span><span class="p">])</span>
    <span class="c1"># Get unique labels</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">mask_same_label</span> <span class="o">=</span> <span class="n">identify_repeating_same_label_in_video</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>

    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="o">~</span><span class="n">mask_same_label</span><span class="p">]</span>

    <span class="c1"># Create sub-folders for experiment and its correct/incorrect predictions</span>
    <span class="n">exp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
    <span class="n">correct_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s2">&quot;standalone&quot;</span><span class="p">,</span> <span class="s2">&quot;correct&quot;</span><span class="p">)</span>
    <span class="n">incorrect_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s2">&quot;standalone&quot;</span><span class="p">,</span> <span class="s2">&quot;incorrect&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">correct_dir</span><span class="p">,</span> <span class="n">incorrect_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">subdir</span><span class="p">)</span>

    <span class="c1"># For each label, stratify by correct and incorrect predictions</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="c1"># Filter for correct/incorrectly predicted</span>
        <span class="n">df_label</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
        <span class="n">df_correct</span> <span class="o">=</span> <span class="n">df_label</span><span class="p">[</span><span class="n">df_label</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">df_label</span><span class="o">.</span><span class="n">pred</span><span class="p">]</span>
        <span class="n">df_incorrect</span> <span class="o">=</span> <span class="n">df_label</span><span class="p">[</span><span class="n">df_label</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="n">df_label</span><span class="o">.</span><span class="n">pred</span><span class="p">]</span>

        <span class="c1"># Sample at most 9 images to plot</span>
        <span class="n">df_correct</span> <span class="o">=</span> <span class="n">df_correct</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_correct</span><span class="p">)))</span>
        <span class="n">df_incorrect</span> <span class="o">=</span> <span class="n">df_incorrect</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_incorrect</span><span class="p">)))</span>

        <span class="c1"># Get paths to images</span>
        <span class="n">correct_paths</span> <span class="o">=</span> <span class="n">df_correct</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">incorrect_paths</span> <span class="o">=</span> <span class="n">df_incorrect</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Create gridplot from sampled images</span>
        <span class="n">viz_utils</span><span class="o">.</span><span class="n">gridplot_images_from_paths</span><span class="p">(</span>
            <span class="n">correct_paths</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> (correct).png&quot;</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="n">correct_dir</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Classified (</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">viz_utils</span><span class="o">.</span><span class="n">gridplot_images_from_paths</span><span class="p">(</span>
            <span class="n">incorrect_paths</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> (misclassified).png&quot;</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="n">incorrect_dir</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Misclassified (</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="get_highest_loss_samples">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.get_highest_loss_samples">[docs]</a>
<span class="k">def</span> <span class="nf">get_highest_loss_samples</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get predicted samples with the highest loss.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pd.DataFrame</span>
<span class="sd">        Each row is a prediction</span>
<span class="sd">    n : int, optional</span>
<span class="sd">        Number of samples per label</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Table with sampled highest losses per label</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_samples</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_samples</span></div>



<span class="c1">################################################################################</span>
<span class="c1">#                               Helper Functions                               #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="load_image">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.load_image">[docs]</a>
<span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">as_numpy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">transform_hparams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load image as tensor or numpy</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img_path : str</span>
<span class="sd">        Path to image</span>
<span class="sd">    as_numpy : bool, optional</span>
<span class="sd">        If True, return numpy array, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor or np.ndarray (if as_numpy)</span>
<span class="sd">        Loaded and transformed image (images, if transform returns multiple images)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load and transform image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">read_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">ImageReadMode</span><span class="o">.</span><span class="n">RGB</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span>
        <span class="n">img</span><span class="p">,</span>
        <span class="o">**</span><span class="n">transform_hparams</span>
    <span class="p">)</span>

    <span class="c1"># If specified, convert to numpy and ensure channels are last</span>
    <span class="k">if</span> <span class="n">as_numpy</span><span class="p">:</span>
        <span class="c1"># Attempt to remove empty first dimension</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># CASE 1: Multiple images returned as a result of augmentation</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># CASE 2: Only single image as expected</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span></div>



<div class="viewcode-block" id="transform_image">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.transform_image">[docs]</a>
<span class="k">def</span> <span class="nf">transform_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hparams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms image, as done during training.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Transforms include: </span>
<span class="sd">        - Resize the image to (256, 256)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : np.array</span>
<span class="sd">        An image</span>
<span class="sd">    augment : bool, optional</span>
<span class="sd">        If True, perform augmentations during training</span>
<span class="sd">    n : int, optional</span>
<span class="sd">        If augmenting, the number of times to randomly augment the image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.array</span>
<span class="sd">        Transformed image/s with extra first dimension, useful if n &gt; 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get parameters (or defaults)</span>
    <span class="n">hparams</span> <span class="o">=</span> <span class="n">hparams</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;img_size&quot;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">)</span>
    <span class="n">crop_scale</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crop_scale&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

    <span class="c1"># Convert to torch</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">transforms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Add resize transform</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">img_size</span><span class="p">))</span>

    <span class="c1"># If specified, add training augmentations</span>
    <span class="k">if</span> <span class="n">augment</span><span class="p">:</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">prep_augmentations</span><span class="p">(</span>
            <span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span>
            <span class="n">crop_scale</span><span class="o">=</span><span class="n">crop_scale</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
    <span class="n">transforms</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">transforms</span><span class="p">)</span>

    <span class="c1"># Get RNG state (for later restoration)</span>
    <span class="n">random_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_rng_state</span><span class="p">()</span>
    <span class="c1"># Set random seed</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

    <span class="c1"># Augment each image separately</span>
    <span class="n">img_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">transforms</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>

    <span class="c1"># Normalize between 0 and 1</span>
    <span class="n">img_stack</span> <span class="o">=</span> <span class="n">img_stack</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>

    <span class="c1"># Restore original RNG state</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">set_rng_state</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img_stack</span></div>



<div class="viewcode-block" id="get_da_transform">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.get_da_transform">[docs]</a>
<span class="k">def</span> <span class="nf">get_da_transform</span><span class="p">(</span><span class="n">da_transform_name</span><span class="p">,</span> <span class="n">src_paths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return domain adaptation (DA) transform</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Ensures that it&#39;s converted to a PyTorch tensor post-transform</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    da_transform_name : str</span>
<span class="sd">        Name of DA transform</span>
<span class="sd">    src_paths : list</span>
<span class="sd">        List of source dataset paths</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    albumentations.Compose</span>
<span class="sd">        Composed DA transform</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Early return identity, if none</span>
    <span class="k">if</span> <span class="n">da_transform_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>

    <span class="c1"># Ensure valid transform is provided</span>
    <span class="k">if</span> <span class="n">da_transform_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fda&quot;</span><span class="p">,</span> <span class="s2">&quot;hm&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`da_transform_name` must be in </span><span class="si">{</span><span class="p">(</span><span class="s1">&#39;fda&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hm&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Load transform</span>
    <span class="c1"># CASE 1: Fourier Domain Adaptation</span>
    <span class="k">if</span> <span class="n">da_transform_name</span> <span class="o">==</span> <span class="s2">&quot;fda&quot;</span><span class="p">:</span>
        <span class="n">da_transform</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">FDA</span><span class="p">(</span>
            <span class="n">src_paths</span><span class="p">,</span>
            <span class="n">beta_limit</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">read_fn</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">load_image</span><span class="p">,</span> <span class="n">as_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="c1"># CASE 2: Histogram Matching</span>
    <span class="k">elif</span> <span class="n">da_transform_name</span> <span class="o">==</span> <span class="s2">&quot;hm&quot;</span><span class="p">:</span>
        <span class="n">da_transform</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">HistogramMatching</span><span class="p">(</span>
            <span class="n">src_paths</span><span class="p">,</span>
            <span class="n">blend_ratio</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">read_fn</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">load_image</span><span class="p">,</span> <span class="n">as_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="c1"># Compose transform</span>
    <span class="c1"># NOTE: Ensure converted to PyTorch tensor after</span>
    <span class="n">transforms</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">da_transform</span><span class="p">,</span> <span class="n">ToTensorV2</span><span class="p">()])</span>

    <span class="k">return</span> <span class="n">transforms</span></div>



<div class="viewcode-block" id="get_local_groups">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.get_local_groups">[docs]</a>
<span class="k">def</span> <span class="nf">get_local_groups</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify local groups of consecutive labels/predictions in a list of values.</span>
<span class="sd">    Return a list of increasing integers which identify these groups.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Input of [1, 1, 2, 1, 1] would return [1, 1, 2, 3, 3]. Groupings would be:</span>
<span class="sd">        - Group 1: (1, 1)</span>
<span class="sd">        - Group 2: (2)</span>
<span class="sd">        - Group 3: (1, 1)</span>
<span class="sd">    </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    values: list</span>
<span class="sd">        List of values in some sequential order</span>
<span class="sd">    col : str</span>
<span class="sd">        Name of column to check for consecutive values</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Increasing integer values, which represent each local group of</span>
<span class="sd">        images with the same label.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">curr_val</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prev_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">local_groups</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">prev_val</span><span class="p">:</span>
            <span class="n">curr_val</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">prev_val</span> <span class="o">=</span> <span class="n">val</span>
        
        <span class="n">local_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_val</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">local_groups</span></div>



<div class="viewcode-block" id="identify_repeating_segments">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.identify_repeating_segments">[docs]</a>
<span class="k">def</span> <span class="nf">identify_repeating_segments</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create boolean mask, where True is given to list values adjacent to the same</span>
<span class="sd">    value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    values: list</span>
<span class="sd">        List of values</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.array</span>
<span class="sd">        Boolean mask of repeating value segments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prev_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">segment_len</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="c1"># CASE 0: Part of repeating segment</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">prev_val</span><span class="p">:</span>
            <span class="n">segment_len</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1"># CASE 1: New value encountered</span>
        <span class="c1"># CASE 1.0: Default value (to skip)</span>
        <span class="k">if</span> <span class="n">prev_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prev_val</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">continue</span>

        <span class="c1"># CASE 1.1: Extend mask</span>
        <span class="n">mask</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">segment_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="n">segment_len</span><span class="p">)</span>

        <span class="c1"># Update accumulators</span>
        <span class="n">segment_len</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prev_val</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># Handle last segment</span>
    <span class="k">if</span> <span class="n">prev_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">segment_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="n">segment_len</span><span class="p">)</span>

    <span class="c1"># Ensure mask is the same length as values</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>



<div class="viewcode-block" id="filter_most_confident">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.filter_most_confident">[docs]</a>
<span class="k">def</span> <span class="nf">filter_most_confident</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given predictions for all images across multiple US sequences, filter the</span>
<span class="sd">    prediction with the highest confidence (based on output activation).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    local : bool, optional</span>
<span class="sd">        If True, gets the most confident prediction within each group of</span>
<span class="sd">        consecutive images with the same label. Otherwise, aggregates by</span>
<span class="sd">        predicted view label to find the most confident view label predictions,</span>
<span class="sd">        by default False.</span>
<span class="sd">    top_k : int, optional</span>
<span class="sd">        Get top K most confident view label predictions, by default 1.</span>
<span class="sd">    groupby : str, optional</span>
<span class="sd">        If `local=False`, &quot;pred&quot; would find the most confident view prediction</span>
<span class="sd">        (irrespective of the ground truth), and &quot;label&quot; would find the most</span>
<span class="sd">        confident prediction grouping by the ground-truth label</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Filtered predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># CASE 1: For each sequence, get the strongest predicted view</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">local</span><span class="p">:</span>
        <span class="c1"># Get most confident pred per view per sequence (ignoring seq. number)</span>
        <span class="k">assert</span> <span class="n">groupby</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span>
        <span class="n">df_seqs</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="n">groupby</span><span class="p">])</span>
        <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df_seqs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># CASE 2: </span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get most confident pred per group of consecutive labels per sequence</span>
        <span class="c1"># 0. Sort by id, visit and sequence number</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_number&quot;</span><span class="p">])</span>

        <span class="c1"># 1. Identify local groups of consecutive labels</span>
        <span class="n">local_grps_per_seq</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">get_local_groups</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;local_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">local_grps_per_seq</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">df_seqs</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="s2">&quot;local_group&quot;</span><span class="p">])</span>
        <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df_seqs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">out</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>

    <span class="k">return</span> <span class="n">df_filtered</span></div>



<div class="viewcode-block" id="identify_repeating_same_label_in_video">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.identify_repeating_same_label_in_video">[docs]</a>
<span class="k">def</span> <span class="nf">identify_repeating_same_label_in_video</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">repeating</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given predictions on US videos, identify images which have consecutive</span>
<span class="sd">    images with the same label.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pandas.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    repeating : bool, optional</span>
<span class="sd">        If True, filter for repeating same label frames. Otherwise, filter for</span>
<span class="sd">        frames that are NOT adjacent to frames of the same label, by default</span>
<span class="sd">        True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.array</span>
<span class="sd">        Boolean mask to keep images that ARE or ARE NOT adjacent to</span>
<span class="sd">        same-label image frames</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># PRECONDITION: Index must be unique</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="s2">&quot;Duplicate index value found!&quot;</span>

    <span class="c1"># Early return, if empty</span>
    <span class="k">if</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="c1"># Create copy and ensure videos are in order</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_number&quot;</span><span class="p">])</span>
    <span class="c1"># Reset index (necessary for reordering)</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get boolean mask for images adjacent to images of the same label</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">identify_repeating_segments</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

    <span class="c1"># If specified, only get those that are NOT adjacent to same-label images</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">repeating</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>

    <span class="c1"># Reorder mask to match index</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mask</span></div>



<div class="viewcode-block" id="extract_from_label">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.extract_from_label">[docs]</a>
<span class="k">def</span> <span class="nf">extract_from_label</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">extract</span><span class="o">=</span><span class="s2">&quot;plane&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new column called &quot;&lt;col&gt;_&lt;extract&gt;&quot;, made from extracting data</span>
<span class="sd">    from a column of label/predicted label strings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Contains &lt;col&gt; column with strings of the form &lt;plane&gt;_&lt;side&gt;</span>
<span class="sd">    col : str, optional</span>
<span class="sd">        Name of column of strings, by default &quot;label&quot;</span>
<span class="sd">    extract : str, optional</span>
<span class="sd">        What to extract. One of &quot;plane&quot; or &quot;side&quot;, by default &quot;plane&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">extract</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_from_label</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">extract</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_new_seq_numbers">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.get_new_seq_numbers">[docs]</a>
<span class="k">def</span> <span class="nf">get_new_seq_numbers</span><span class="p">(</span><span class="n">df_pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Since sequence numbers are not all present (due to unlabeled images), create</span>
<span class="sd">    new sequence numbers from order of existing images in the sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pd.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        df_pred with added column &quot;seq_number_new&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sort by sequence number</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_number&quot;</span><span class="p">],</span>
                                  <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get new sequence numbers (rank)</span>
    <span class="n">new_seq_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

    <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;seq_number_new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_seq_numbers</span>

    <span class="k">return</span> <span class="n">df_pred</span></div>



<div class="viewcode-block" id="show_example_side_predictions">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.show_example_side_predictions">[docs]</a>
<span class="k">def</span> <span class="nf">show_example_side_predictions</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">relative_side</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">label_part</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given label sequences and their corresponding side predictions (encoded as</span>
<span class="sd">    single characters), print full label and prediction sequences with incorrect</span>
<span class="sd">    predictions colored red.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pd.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of random unique sequences to show</span>
<span class="sd">    relative_side : bool</span>
<span class="sd">        If True, predicted labels must be relative side (e.g., Transverse_First)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If relative side label</span>
    <span class="k">if</span> <span class="n">relative_side</span><span class="p">:</span>
        <span class="n">side_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;First&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;Second&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">side_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Left&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;Right&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,}</span>

    <span class="c1"># How to determine side index</span>
    <span class="n">side_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">side_to_idx</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">extract_from_label</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">label_part</span> <span class="o">==</span> <span class="s2">&quot;side&quot;</span><span class="p">:</span>
        <span class="n">side_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">side_to_idx</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid `label_part` provided in `show_example_side_predictions`! Skipping...&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Apply function above to labels/preds</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;seq_number&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">side_func</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;seq_number&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">side_func</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="c1"># Choose random sequence</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">labels_str</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">preds_str</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Color prediction sequence by correct/wrong</span>
        <span class="n">colored_pred_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels_str</span><span class="p">)):</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">preds_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">color_code</span> <span class="o">=</span> <span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="k">if</span> <span class="n">labels_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">preds_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> \
                <span class="n">Fore</span><span class="o">.</span><span class="n">MAGENTA</span>
            <span class="n">colored_pred_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color_code</span><span class="si">}{</span><span class="n">pred</span><span class="si">}{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">labels_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">colored_pred_str</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_save_dir_by_flags">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.create_save_dir_by_flags">[docs]</a>
<span class="k">def</span> <span class="nf">create_save_dir_by_flags</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_EVAL_SPLIT</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">extra_flags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create directory to save dset predictions, based on experiment name and</span>
<span class="sd">    keyword arguments</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str, optional</span>
<span class="sd">        Name of dataset</span>
<span class="sd">    **extra_flags : dict, optional</span>
<span class="sd">        Keyword arguments, specifying extra flags used during inference</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Expected directory to save dset predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add mask bladder, if dset doesn&#39;t contain bladders</span>
    <span class="k">if</span> <span class="n">FORCE_MASK_BLADDER</span> <span class="ow">and</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">DSETS_MISSING_BLADDER</span><span class="p">:</span>
        <span class="n">extra_flags</span><span class="p">[</span><span class="s2">&quot;mask_bladder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Add true flags to the experiment name</span>
    <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">extra_flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Skip, if false-y</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># CASE 1: String</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">exp_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># CASE 2: Boolean or other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exp_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Create inference directory, if not exists</span>
    <span class="n">inference_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">DIR_INFERENCE</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inference_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">inference_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inference_dir</span></div>



<div class="viewcode-block" id="create_save_path">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.create_save_path">[docs]</a>
<span class="k">def</span> <span class="nf">create_save_path</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">extra_flags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create file path to dset predictions, based on experiment name and keyword</span>
<span class="sd">    arguments</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str, optional</span>
<span class="sd">        Name of dataset</span>
<span class="sd">    split : str, optional</span>
<span class="sd">        Specific split of dataset. One of (train/val/test)</span>
<span class="sd">    **extra_flags : dict, optional</span>
<span class="sd">        Keyword arguments, specifying extra flags used during inference</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Expected path to dset predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create inference directory path</span>
    <span class="n">inference_dir</span> <span class="o">=</span> <span class="n">create_save_dir_by_flags</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_flags</span><span class="p">)</span>

    <span class="c1"># Expected path to dset inference</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_set_results.csv&quot;</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inference_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">save_path</span></div>



<div class="viewcode-block" id="calculate_per_seq_silhouette_score">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.calculate_per_seq_silhouette_score">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_per_seq_silhouette_score</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span>
                                       <span class="n">label_part</span><span class="o">=</span><span class="s2">&quot;side&quot;</span><span class="p">,</span>
                                       <span class="n">exclude_labels</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">,)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a per - ultrasound sequence Silhouette score.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str, optional</span>
<span class="sd">        Name of dataset</span>
<span class="sd">    split : str, optional</span>
<span class="sd">        Specific split of dataset. One of (train/val/test)</span>
<span class="sd">    label_part : str, optional</span>
<span class="sd">        If specified, either `side` or `plane` is extracted from each label</span>
<span class="sd">        and used as the given label, by default &quot;side&quot;</span>
<span class="sd">    exclude_labels : list or array-like, optional</span>
<span class="sd">        List of labels whose matching samples will be excluded when calculating</span>
<span class="sd">        the Silhouette score, by default (&quot;None&quot;,)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Mean Silhouette Score across unique ultrasound sequences</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load embeddings</span>
    <span class="n">df_embeds</span> <span class="o">=</span> <span class="n">embed</span><span class="o">.</span><span class="n">get_embeds</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>
    <span class="n">df_embeds</span> <span class="o">=</span> <span class="n">df_embeds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="s2">&quot;files&quot;</span><span class="p">})</span>    <span class="c1"># legacy name</span>

    <span class="c1"># Extract metadata from image file paths</span>
    <span class="n">df_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">df_embeds</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]})</span>
    <span class="n">df_metadata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_data_from_filename</span><span class="p">(</span><span class="n">df_metadata</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># Get view labels (if any) for all extracted images</span>
    <span class="n">view_labels</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_labels_for_filenames</span><span class="p">(</span>
        <span class="n">filenames</span><span class="p">,</span> <span class="n">label_part</span><span class="o">=</span><span class="n">label_part</span><span class="p">)</span>
    <span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_labels</span>

    <span class="c1"># Isolate UMAP embeddings (all patients)</span>
    <span class="n">df_embeds_only</span> <span class="o">=</span> <span class="n">df_embeds</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>

    <span class="c1"># Mask out excluded labels</span>
    <span class="k">if</span> <span class="n">exclude_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">exclude_labels</span><span class="p">)</span>
        <span class="n">df_embeds_only</span> <span class="o">=</span> <span class="n">df_embeds_only</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">df_metadata</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># Calculate per-sequence Silhouette score</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span><span class="p">,</span> <span class="n">visit</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">p_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;visit&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">visit</span><span class="p">))</span>
        <span class="c1"># Ignore, if number of labels &lt; 2</span>
        <span class="k">if</span> <span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skmetrics</span><span class="o">.</span><span class="n">silhouette_samples</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">df_embeds_only</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span>
            <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_accuracy">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.calculate_accuracy">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_accuracy</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">pred_col</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a table of predictions with columns &quot;label&quot; and &quot;pred&quot;, compute</span>
<span class="sd">    accuracy rounded to 4 decimal places.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_pred : pd.DataFrame</span>
<span class="sd">        Model predictions. Each row contains a label,</span>
<span class="sd">        prediction, and other patient and sequence-related metadata.</span>
<span class="sd">    label_col : str, optional</span>
<span class="sd">        Name of label column, by default &quot;label&quot;</span>
<span class="sd">    pred_col : str, optional</span>
<span class="sd">        Name of label column, by default &quot;pred&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Accuracy rounded to 4 decimal places</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Early return, if empty</span>
    <span class="k">if</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>

    <span class="c1"># Compute accuracy</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">skmetrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">label_col</span><span class="p">],</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">pred_col</span><span class="p">])</span>

    <span class="c1"># Round decimals</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">acc</span></div>



<div class="viewcode-block" id="load_view_predictions">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.load_view_predictions">[docs]</a>
<span class="k">def</span> <span class="nf">load_view_predictions</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load predictions by model given by `exp_name` on dataset `dset`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str</span>
<span class="sd">        Name of evaluation split or test dataset</span>
<span class="sd">    **infer_kwargs : Keyword arguments which includes:</span>
<span class="sd">        mask_bladder : bool, optional</span>
<span class="sd">            If True, bladder predictions are masked out, by default False</span>
<span class="sd">        test_time_aug : bool, optional</span>
<span class="sd">            If True, perform test-time augmentation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Each row is an image with a view label (plane/side) predicted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Specify path to inference file</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">create_save_path</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">)</span>
    <span class="c1"># Raise error, if predictions not found</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predictions not found on dataset </span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;`exp_name`: </span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Load results</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

    <span class="c1"># 3. Ensure no duplicates (or sequential data only)</span>
    <span class="c1"># NOTE: Because Stanford had duplicate metadata, there were duplicate preds</span>
    <span class="n">mask_bladder</span> <span class="o">=</span> <span class="n">infer_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask_bladder&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask_bladder</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_number&quot;</span><span class="p">])</span>

    <span class="c1"># 4. Add side/plane label, if not present</span>
    <span class="k">for</span> <span class="n">label_part</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_PARTS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">label_part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_pred</span><span class="p">[</span><span class="n">label_part</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_labels_for_filenames</span><span class="p">(</span>
                <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label_part</span><span class="o">=</span><span class="n">label_part</span><span class="p">)</span>

    <span class="c1"># 5. Add HN labels, if not already exists. NOTE: Needs side label to work</span>
    <span class="k">if</span> <span class="s2">&quot;hn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_pred</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_hn_labels</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>

    <span class="c1"># 6. Specify which images are at label boundaries</span>
    <span class="c1"># NOTE: Disabled for now</span>
    <span class="c1"># df_pred[&quot;at_label_boundary&quot;] = utils.get_label_boundaries(df_pred)</span>

    <span class="k">return</span> <span class="n">df_pred</span></div>



<div class="viewcode-block" id="load_side_plane_view_predictions">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.load_side_plane_view_predictions">[docs]</a>
<span class="k">def</span> <span class="nf">load_side_plane_view_predictions</span><span class="p">(</span><span class="n">side_exp_name</span><span class="p">,</span> <span class="n">plane_exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span>
                                     <span class="n">mask_bladder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load view label predictions for side and plane model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    side_exp_name : str</span>
<span class="sd">        Name of side experiment</span>
<span class="sd">    plane_exp_name : str</span>
<span class="sd">        Name of plane experiment</span>
<span class="sd">    dset : str</span>
<span class="sd">        Name of evaluation split or test dataset</span>
<span class="sd">    mask_bladder : bool, optional</span>
<span class="sd">        If True, bladder predictions are masked out, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Contains view label predictions (side and plane) for dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load side predictions</span>
    <span class="k">if</span> <span class="n">side_exp_name</span> <span class="o">!=</span> <span class="s2">&quot;canonical&quot;</span><span class="p">:</span>
        <span class="n">df_side_preds</span> <span class="o">=</span> <span class="n">load_view_predictions</span><span class="p">(</span>
            <span class="n">side_exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">mask_bladder</span><span class="o">=</span><span class="n">mask_bladder</span><span class="p">)</span>
        <span class="c1"># Rename columns</span>
        <span class="n">df_side_preds</span> <span class="o">=</span> <span class="n">df_side_preds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;side&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="s2">&quot;side_pred&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="s2">&quot;side_prob&quot;</span><span class="p">,</span>
            <span class="s2">&quot;out&quot;</span><span class="p">:</span> <span class="s2">&quot;side_out&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">df_side_preds</span> <span class="o">=</span> <span class="n">df_side_preds</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">df_side_preds</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>

        <span class="c1"># Fix slashes in filenames</span>
        <span class="n">df_side_preds</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_side_preds</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">)</span>

    <span class="c1"># Load plane predictions</span>
    <span class="k">if</span> <span class="n">plane_exp_name</span> <span class="o">!=</span> <span class="s2">&quot;canonical&quot;</span><span class="p">:</span>
        <span class="n">df_plane_preds</span> <span class="o">=</span> <span class="n">load_view_predictions</span><span class="p">(</span>
            <span class="n">plane_exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">mask_bladder</span><span class="o">=</span><span class="n">mask_bladder</span><span class="p">)</span>
        <span class="c1"># Rename columns</span>
        <span class="n">df_plane_preds</span> <span class="o">=</span> <span class="n">df_plane_preds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;plane&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="s2">&quot;plane_pred&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prob&quot;</span><span class="p">:</span> <span class="s2">&quot;plane_prob&quot;</span><span class="p">,</span>
            <span class="s2">&quot;out&quot;</span><span class="p">:</span> <span class="s2">&quot;plane_out&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">df_plane_preds</span> <span class="o">=</span> <span class="n">df_plane_preds</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">df_plane_preds</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>

        <span class="c1"># Fix slashes in filenames</span>
        <span class="n">df_plane_preds</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_plane_preds</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">)</span>

    <span class="c1"># CASE 1: Both experiments specified are valid models</span>
    <span class="k">if</span> <span class="n">side_exp_name</span> <span class="o">!=</span> <span class="s2">&quot;canonical&quot;</span> <span class="ow">and</span> <span class="n">plane_exp_name</span> <span class="o">!=</span> <span class="s2">&quot;canonical&quot;</span><span class="p">:</span>
        <span class="c1"># Merge predictions</span>
        <span class="n">duplicate_suffix</span> <span class="o">=</span> <span class="s2">&quot;_duplicate&quot;</span>
        <span class="n">df_view_preds</span> <span class="o">=</span> <span class="n">df_side_preds</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_plane_preds</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">duplicate_suffix</span><span class="p">))</span>

        <span class="c1"># Remove duplicate columns</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">df_view_preds</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">duplicate_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">duplicate_suffix</span><span class="p">)]</span>
        <span class="n">df_view_preds</span> <span class="o">=</span> <span class="n">df_view_preds</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">duplicate_cols</span><span class="p">)</span>
    <span class="c1"># CASE 2: Both are specified to use canonical labels</span>
    <span class="k">elif</span> <span class="n">side_exp_name</span> <span class="o">==</span> <span class="s2">&quot;canonical&quot;</span> <span class="ow">and</span> <span class="n">plane_exp_name</span> <span class="o">==</span> <span class="s2">&quot;canonical&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Case not handled!&quot;</span><span class="p">)</span>
    <span class="c1"># CASE 3: Use side labels</span>
    <span class="k">elif</span> <span class="n">side_exp_name</span> <span class="o">==</span> <span class="s2">&quot;canonical&quot;</span><span class="p">:</span>
        <span class="n">df_view_preds</span> <span class="o">=</span> <span class="n">df_plane_preds</span>
        <span class="n">df_view_preds</span><span class="p">[</span><span class="s2">&quot;side_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_view_preds</span><span class="p">[</span><span class="s2">&quot;plane&quot;</span><span class="p">]</span>
        <span class="n">df_view_preds</span><span class="p">[</span><span class="s2">&quot;side_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">df_view_preds</span><span class="p">[</span><span class="s2">&quot;side_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># CASE 4: Use plane labels</span>
    <span class="k">elif</span> <span class="n">plane_exp_name</span> <span class="o">==</span> <span class="s2">&quot;canonical&quot;</span><span class="p">:</span>
        <span class="n">df_view_preds</span> <span class="o">=</span> <span class="n">df_side_preds</span>
        <span class="n">df_view_preds</span><span class="p">[</span><span class="s2">&quot;plane_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_view_preds</span><span class="p">[</span><span class="s2">&quot;plane&quot;</span><span class="p">]</span>
        <span class="n">df_view_preds</span><span class="p">[</span><span class="s2">&quot;plane_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">df_view_preds</span><span class="p">[</span><span class="s2">&quot;plane_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="k">return</span> <span class="n">df_view_preds</span></div>



<div class="viewcode-block" id="scale_and_round">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.scale_and_round">[docs]</a>
<span class="k">def</span> <span class="nf">scale_and_round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_places</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scale and round if value is an integer or float.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : Any</span>
<span class="sd">        Any object</span>
<span class="sd">    factor : int</span>
<span class="sd">        Factor to multiply by</span>
<span class="sd">    num_places : int</span>
<span class="sd">        Number of decimals to round</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">num_places</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>



<span class="c1">################################################################################</span>
<span class="c1">#                                  Main Flows                                  #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="infer_dset">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.infer_dset">[docs]</a>
<span class="k">def</span> <span class="nf">infer_dset</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span>
               <span class="n">seq_number_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">mask_bladder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">test_time_aug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">da_transform_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">overwrite_existing</span><span class="o">=</span><span class="n">OVERWRITE_EXISTING</span><span class="p">,</span>
               <span class="o">**</span><span class="n">overwrite_hparams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform inference on dset, and saves results</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str, optional</span>
<span class="sd">        Name of dataset</span>
<span class="sd">    split : str, optional</span>
<span class="sd">        Specific split of dataset. One of (train/val/test)</span>
<span class="sd">    seq_number_limit : int, optional</span>
<span class="sd">        If provided, filters out dset split samples with sequence numbers higher</span>
<span class="sd">        than this value, by default None.</span>
<span class="sd">    mask_bladder : bool, optional</span>
<span class="sd">        If True, mask out predictions on bladder/middle side, leaving only</span>
<span class="sd">        kidney labels. Defaults to False.</span>
<span class="sd">    test_time_aug : bool, optional</span>
<span class="sd">        If True, perform test-time augmentation.</span>
<span class="sd">    da_transform_name : str, optional</span>
<span class="sd">        If provided, performs domain adaptation transform on test images, by</span>
<span class="sd">        default None. Must be one of (&quot;fda&quot;, &quot;hm&quot;).</span>
<span class="sd">    overwrite_existing : bool, optional</span>
<span class="sd">        If True and prediction file already exists, overwrite existing, by</span>
<span class="sd">        default OVERWRITE_EXISTING.</span>
<span class="sd">    overwrite_hparams : dict, optional</span>
<span class="sd">        Keyword arguments to overwrite experiment hyperparameters</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If `exp_name` does not lead to a valid training directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Assertion on `da_transform`</span>
    <span class="k">assert</span> <span class="n">da_transform_name</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fda&quot;</span><span class="p">,</span> <span class="s2">&quot;hm&quot;</span><span class="p">),</span> <span class="s1">&#39;`da_transform_name` must be one of (None, &quot;fda&quot;, &quot;hm&quot;)&#39;</span>

    <span class="c1"># 0. Create path to save predictions</span>
    <span class="n">pred_save_path</span> <span class="o">=</span> <span class="n">create_save_path</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                                      <span class="n">seq_number_limit</span><span class="o">=</span><span class="n">seq_number_limit</span><span class="p">,</span>
                                      <span class="n">mask_bladder</span><span class="o">=</span><span class="n">mask_bladder</span><span class="p">,</span>
                                      <span class="n">test_time_aug</span><span class="o">=</span><span class="n">test_time_aug</span><span class="p">,</span>
                                      <span class="n">da_transform_name</span><span class="o">=</span><span class="n">da_transform_name</span><span class="p">)</span>
    <span class="c1"># Early return, if prediction already made</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pred_save_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite_existing</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># 0. Get experiment directory, where model was trained</span>
    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">load_model</span><span class="o">.</span><span class="n">get_exp_dir</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>

    <span class="c1"># 1. Get experiment hyperparameters</span>
    <span class="n">hparams</span> <span class="o">=</span> <span class="n">load_model</span><span class="o">.</span><span class="n">get_hyperparameters</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

    <span class="c1"># 2. If domain adaptation transform specified, load original training set</span>
    <span class="c1">#    images and create transform</span>
    <span class="n">da_transform</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">da_transform_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Get training data</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">load_data</span><span class="o">.</span><span class="n">setup_data_module</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">self_supervised</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df_train_metadata</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">filter_metadata</span><span class="p">(</span><span class="n">dset</span><span class="o">=</span><span class="s2">&quot;sickkids&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

        <span class="c1"># Filter for existing images</span>
        <span class="n">exists_mask</span> <span class="o">=</span> <span class="n">df_train_metadata</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">)</span>
        <span class="n">df_train_metadata</span> <span class="o">=</span> <span class="n">df_train_metadata</span><span class="p">[</span><span class="n">exists_mask</span><span class="p">]</span>

        <span class="c1"># Get 200 examples from each label</span>
        <span class="n">src_paths</span> <span class="o">=</span> <span class="n">df_train_metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">da_transform</span> <span class="o">=</span> <span class="n">get_da_transform</span><span class="p">(</span><span class="n">da_transform_name</span><span class="p">,</span> <span class="n">src_paths</span><span class="p">)</span>

    <span class="c1"># Overwrite hyperparameters (can change dataset loaded)</span>
    <span class="n">hparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overwrite_hparams</span><span class="p">)</span>

    <span class="c1"># 4. Load existing model and send to device</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="o">.</span><span class="n">load_pretrained_from_exp_name</span><span class="p">(</span>
        <span class="n">exp_name</span><span class="p">,</span> <span class="n">overwrite_hparams</span><span class="o">=</span><span class="n">overwrite_hparams</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

    <span class="c1"># 3. Load data</span>
    <span class="c1"># NOTE: Ensure data is loaded in the non-SSL mode</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">load_data</span><span class="o">.</span><span class="n">setup_data_module</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">self_supervised</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># 3.1 Get metadata (for specified split)</span>
    <span class="n">df_metadata</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">filter_metadata</span><span class="p">(</span><span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>
    <span class="c1"># 3.2 If provided, filter out high sequence number images</span>
    <span class="k">if</span> <span class="n">seq_number_limit</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;seq_number&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">seq_number_limit</span><span class="p">)</span>
        <span class="n">df_metadata</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="c1"># 3.3 Sort, so no mismatch occurs due to groupby sorting</span>
    <span class="n">df_metadata</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 4. Predict on dset split</span>
    <span class="c1"># If multi-output model</span>
    <span class="k">if</span> <span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_output&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">da_transform_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Domain Adaptation transform is not implemented for &quot;</span>
                <span class="s2">&quot;multi-output model!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hparams</span><span class="p">[</span><span class="s2">&quot;full_seq&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Multi-output model is not implemented &quot;</span>
                                      <span class="s2">&quot;for single-images!&quot;</span><span class="p">)</span>
        <span class="c1"># Perform inference one sequence at a time</span>
        <span class="n">df_preds</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">multi_predict_on_sequences</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">img_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="n">hparams</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Remove groupby index</span>
        <span class="n">df_preds</span> <span class="o">=</span> <span class="n">df_preds</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If temporal model</span>
        <span class="k">if</span> <span class="n">hparams</span><span class="p">[</span><span class="s2">&quot;full_seq&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">da_transform_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Domain Adaptation transform is not implemented for &quot;</span>
                    <span class="s2">&quot;video model!&quot;</span><span class="p">)</span>
            <span class="c1"># CASE 1: Dataset of US videos</span>
            <span class="k">if</span> <span class="n">dset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">DSETS_NON_SEQ</span><span class="p">:</span>
                <span class="c1"># Perform inference one sequence at a time</span>
                <span class="n">df_preds</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span><span class="o">.</span>\
                    <span class="n">progress_apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">predict_on_sequences</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">filenames</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                            <span class="n">img_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">mask_bladder</span><span class="o">=</span><span class="n">mask_bladder</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">hparams</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="c1"># Remove groupby index</span>
                <span class="n">df_preds</span> <span class="o">=</span> <span class="n">df_preds</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># CASE 2: Dataset of US images</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_preds</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">predict_on_sequences</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                        <span class="n">filenames</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">filename</span><span class="p">],</span>
                        <span class="n">img_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">mask_bladder</span><span class="o">=</span><span class="n">mask_bladder</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">hparams</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">df_preds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_preds</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">df_preds</span> <span class="o">=</span> <span class="n">predict_on_images</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="n">img_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mask_bladder</span><span class="o">=</span><span class="n">mask_bladder</span><span class="p">,</span>
                <span class="n">test_time_aug</span><span class="o">=</span><span class="n">test_time_aug</span><span class="p">,</span>
                <span class="n">da_transform</span><span class="o">=</span><span class="n">da_transform</span><span class="p">,</span>
                <span class="o">**</span><span class="n">hparams</span><span class="p">)</span>

    <span class="c1"># Join to metadata. NOTE: This works because of earlier sorting</span>
    <span class="n">df_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_metadata</span><span class="p">,</span> <span class="n">df_preds</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 5. Save predictions on dset split</span>
    <span class="n">df_metadata</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pred_save_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="embed_dset">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.embed_dset">[docs]</a>
<span class="k">def</span> <span class="nf">embed_dset</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span>
               <span class="n">overwrite_existing</span><span class="o">=</span><span class="n">OVERWRITE_EXISTING</span><span class="p">,</span>
               <span class="o">**</span><span class="n">overwrite_hparams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract embeddings on dset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str, optional</span>
<span class="sd">        Name of dataset</span>
<span class="sd">    split : str, optional</span>
<span class="sd">        Specific split of dataset. One of (train/val/test)</span>
<span class="sd">    overwrite_existing : bool, optional</span>
<span class="sd">        If True and embeddings already exists, overwrite existing, by</span>
<span class="sd">        default OVERWRITE_EXISTING.</span>
<span class="sd">    overwrite_hparams : dict, optional</span>
<span class="sd">        Keyword arguments to overwrite experiment hyperparameters</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If `exp_name` does not lead to a valid training directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 0. Create path to save embeddings</span>
    <span class="n">embed_save_path</span> <span class="o">=</span> <span class="n">embed</span><span class="o">.</span><span class="n">get_save_path</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>

    <span class="c1"># Early return, if embeddings already made</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">embed_save_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite_existing</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># 0. Get experiment directory, where model was trained</span>
    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">load_model</span><span class="o">.</span><span class="n">get_exp_dir</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>

    <span class="c1"># 1 Get experiment hyperparameters</span>
    <span class="n">hparams</span> <span class="o">=</span> <span class="n">load_model</span><span class="o">.</span><span class="n">get_hyperparameters</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="n">hparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overwrite_hparams</span><span class="p">)</span>
    <span class="c1"># NOTE: Ensure full image path is saved in embedding file</span>
    <span class="n">hparams</span><span class="p">[</span><span class="s2">&quot;full_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># 2. Load existing model and send to device</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="o">.</span><span class="n">load_pretrained_from_exp_name</span><span class="p">(</span>
        <span class="n">exp_name</span><span class="p">,</span> <span class="n">overwrite_hparams</span><span class="o">=</span><span class="n">overwrite_hparams</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

    <span class="c1"># NOTE: For non-video datasets, ensure each image is treated independently</span>
    <span class="k">if</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">DSETS_NON_SEQ</span><span class="p">:</span>
        <span class="n">hparams</span><span class="p">[</span><span class="s2">&quot;full_seq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hparams</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># 3. Load data</span>
    <span class="c1"># NOTE: Ensure data is loaded in the non-SSL mode</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">load_data</span><span class="o">.</span><span class="n">setup_data_module</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">self_supervised</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">get_filtered_dataloader</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">)</span>

    <span class="c1"># 5. Extract embeddings and save them</span>
    <span class="n">embed</span><span class="o">.</span><span class="n">extract_embeds</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">save_embed_path</span><span class="o">=</span><span class="n">embed_save_path</span><span class="p">,</span>
        <span class="n">img_dataloader</span><span class="o">=</span><span class="n">dataloader</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span></div>



<div class="viewcode-block" id="analyze_dset_preds">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.analyze_dset_preds">[docs]</a>
<span class="k">def</span> <span class="nf">analyze_dset_preds</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span>
                       <span class="n">log_to_comet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze dset split predictions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dsets : str or list, optional</span>
<span class="sd">        Name of dataset</span>
<span class="sd">    splits : str or list, optional</span>
<span class="sd">        Specific split of dataset. One of (train/val/test)</span>
<span class="sd">    log_to_comet : bool, optional</span>
<span class="sd">        If True, log metrics and UMAPs to Comet ML.</span>
<span class="sd">    **infer_kwargs : Keyword arguments</span>
<span class="sd">        Inference keyword arguments, which includes</span>
<span class="sd">            mask_bladder : bool, optional</span>
<span class="sd">                If True, bladder predictions are masked out, by default False</span>
<span class="sd">            test_time_aug : bool, optional</span>
<span class="sd">                If True, perform test-time augmentation.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If `exp_name` does not lead to a valid training directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 0. Get experiment directory, where model was trained</span>
    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">load_model</span><span class="o">.</span><span class="n">get_exp_dir</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>

    <span class="c1"># 1 Get experiment hyperparameters</span>
    <span class="n">hparams</span> <span class="o">=</span> <span class="n">load_model</span><span class="o">.</span><span class="n">get_hyperparameters</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

    <span class="c1"># 2. If specified, calculate metrics</span>
    <span class="k">if</span> <span class="n">CALCULATE_METRICS</span><span class="p">:</span>
        <span class="c1"># If 2+ dsets provided, calculate metrics on each dset individually</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsets</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">dsets</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span><span class="n">splits</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">splits</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">curr_dset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsets</span><span class="p">):</span>
            <span class="n">curr_split</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">calculate_exp_metrics</span><span class="p">(</span>
                    <span class="n">exp_name</span><span class="o">=</span><span class="n">exp_name</span><span class="p">,</span>
                    <span class="n">dset</span><span class="o">=</span><span class="n">curr_dset</span><span class="p">,</span>
                    <span class="n">split</span><span class="o">=</span><span class="n">curr_split</span><span class="p">,</span>
                    <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span>
                    <span class="n">log_to_comet</span><span class="o">=</span><span class="n">log_to_comet</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># Log error</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Try to perform inference again...&quot;</span><span class="p">)</span>

    <span class="c1"># 3. If specified, create UMAP plots</span>
    <span class="k">if</span> <span class="n">EMBED</span><span class="p">:</span>
        <span class="n">plot_umap</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dsets</span><span class="p">,</span>
                       <span class="n">comet_exp_key</span><span class="o">=</span><span class="n">hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comet_exp_key&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">log_to_comet</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Close all open figures</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../src.scripts.html#src.scripts.model_eval.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run main flows to:</span>
<span class="sd">        1. Perform inference</span>
<span class="sd">        2. Analyze predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exp_names</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">exp_names</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dsets</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">splits</span>
    <span class="c1"># If only one of dset/split is &gt; 1, assume it&#39;s meant to be broadcast</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Only 1 `dset` provided! Assuming same `dset` for all `splits`...&quot;</span><span class="p">)</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="n">dsets</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Only 1 `split` provided! Assuming same `split` for all `dsets`...&quot;</span><span class="p">)</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">splits</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span>

    <span class="c1"># For each experiment, perform inference and analyze results</span>
    <span class="k">for</span> <span class="n">exp_name</span> <span class="ow">in</span> <span class="n">exp_names</span><span class="p">:</span>
        <span class="c1"># Iterate over all specified eval dsets</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">curr_dset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsets</span><span class="p">):</span>
            <span class="n">curr_split</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="c1"># Specify to mask bladder, if it&#39;s a hospital w/o bladder labels</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mask_bladder</span> <span class="ow">or</span> <span class="n">FORCE_MASK_BLADDER</span><span class="p">:</span>
                <span class="n">mask_bladder</span> <span class="o">=</span> <span class="n">curr_dset</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">DSETS_MISSING_BLADDER</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_bladder</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># 2. Create overwrite parameters</span>
            <span class="n">eval_hparams</span> <span class="o">=</span> <span class="n">load_data</span><span class="o">.</span><span class="n">create_eval_hparams</span><span class="p">(</span><span class="n">curr_dset</span><span class="p">,</span> <span class="n">curr_split</span><span class="p">)</span>

            <span class="c1"># 3. Perform inference</span>
            <span class="n">infer_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mask_bladder&quot;</span><span class="p">:</span> <span class="n">mask_bladder</span><span class="p">,</span>
                <span class="s2">&quot;test_time_aug&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">test_time_aug</span><span class="p">,</span>
                <span class="s2">&quot;da_transform_name&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">da_transform_name</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">infer_dset</span><span class="p">(</span><span class="n">exp_name</span><span class="o">=</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">curr_dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">curr_split</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">eval_hparams</span><span class="p">)</span>

            <span class="c1"># 4. Extract embeddings</span>
            <span class="k">if</span> <span class="n">EMBED</span><span class="p">:</span>
                <span class="n">embed_dset</span><span class="p">(</span><span class="n">exp_name</span><span class="o">=</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">curr_dset</span><span class="p">,</span> <span class="o">**</span><span class="n">eval_hparams</span><span class="p">)</span>

            <span class="c1"># 5. Evaluate predictions and embeddings</span>
            <span class="n">analyze_dset_preds</span><span class="p">(</span><span class="n">exp_name</span><span class="o">=</span><span class="n">exp_name</span><span class="p">,</span>
                               <span class="n">dsets</span><span class="o">=</span><span class="n">curr_dset</span><span class="p">,</span>
                               <span class="n">splits</span><span class="o">=</span><span class="n">curr_split</span><span class="p">,</span>
                               <span class="n">log_to_comet</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">log_to_comet</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">)</span>

        <span class="c1"># 6. Create UMAPs embeddings on all dsets together</span>
        <span class="c1"># NOTE: `mask_bladder` is not needed if combining all dsets</span>
        <span class="n">infer_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;mask_bladder&quot;</span><span class="p">)</span>
        <span class="n">analyze_dset_preds</span><span class="p">(</span><span class="n">exp_name</span><span class="o">=</span><span class="n">exp_name</span><span class="p">,</span>
                           <span class="n">dsets</span><span class="o">=</span><span class="n">dsets</span><span class="p">,</span>
                           <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
                           <span class="n">log_to_comet</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">log_to_comet</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">infer_kwargs</span><span class="p">)</span></div>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 0. Initialize ArgumentParser</span>
    <span class="n">PARSER</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">init</span><span class="p">(</span><span class="n">PARSER</span><span class="p">)</span>

    <span class="c1"># 1. Parse arguments</span>
    <span class="n">ARGS</span> <span class="o">=</span> <span class="n">PARSER</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># 2. Run main flows</span>
    <span class="n">main</span><span class="p">(</span><span class="n">ARGS</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Stanley Hua.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>