<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.data_viz.plot_umap &mdash; Renal View Labeling 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Renal View Labeling
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Renal View Labeling</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.data_viz.plot_umap</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.data_viz.plot_umap</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">plot_umap.py</span>

<span class="sd">Description: Plots 2D UMAP embeddings</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Standard libraries</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># Non-standard libraries</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">umap</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">DBSCAN</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Custom libraries</span>
<span class="kn">from</span> <span class="nn">src.data</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">src.data_prep</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">src.data_viz</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">viz_utils</span>
<span class="kn">from</span> <span class="nn">src.scripts.embed</span> <span class="kn">import</span> <span class="n">get_embeds</span>
<span class="kn">from</span> <span class="nn">src.utils.logging</span> <span class="kn">import</span> <span class="n">load_comet_logger</span>


<span class="c1">################################################################################</span>
<span class="c1">#                                    Setup                                     #</span>
<span class="c1">################################################################################</span>
<span class="c1"># Configure logging</span>
<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Disable logging</span>
<span class="c1"># logging.disable()</span>

<span class="c1"># Set random seed</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>

<span class="c1"># Plot theme (light/dark)</span>
<span class="n">THEME</span> <span class="o">=</span> <span class="s2">&quot;dark&quot;</span>

<span class="c1"># Order of labels in plot</span>
<span class="n">VIEW_LABEL_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Sagittal_Right&quot;</span><span class="p">,</span> <span class="s2">&quot;Transverse_Right&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal_Left&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Transverse_Left&quot;</span><span class="p">,</span> <span class="s2">&quot;Bladder&quot;</span><span class="p">]</span>
<span class="n">SIDE_LABEL_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Left&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;Right&quot;</span><span class="p">]</span>
<span class="n">PLANE_LABEL_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Sagittal&quot;</span><span class="p">,</span> <span class="s2">&quot;Transverse&quot;</span><span class="p">,</span> <span class="s2">&quot;Bladder&quot;</span><span class="p">]</span>
<span class="n">HOSPITAL_LABEL_ORDER</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;sickkids&quot;</span><span class="p">,</span> <span class="s2">&quot;sickkids_train&quot;</span><span class="p">,</span> <span class="s2">&quot;sickkids_val&quot;</span><span class="p">,</span> <span class="s2">&quot;sickkids_test&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sickkids_silent_trial&quot;</span><span class="p">,</span> <span class="s2">&quot;stanford&quot;</span><span class="p">,</span> <span class="s2">&quot;stanford_image&quot;</span><span class="p">,</span> <span class="s2">&quot;chop&quot;</span><span class="p">,</span> <span class="s2">&quot;uiowa&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Map `dset` string to more readable string</span>
<span class="n">MAP_DSET_STR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sickkids&quot;</span><span class="p">:</span> <span class="s2">&quot;SickKids&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sickkids_train&quot;</span><span class="p">:</span> <span class="s2">&quot;SickKids (Train)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sickkids_val&quot;</span><span class="p">:</span> <span class="s2">&quot;SickKids (Val)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sickkids_test&quot;</span><span class="p">:</span> <span class="s2">&quot;SickKids (Test)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stanford&quot;</span><span class="p">:</span> <span class="s2">&quot;Stanford&quot;</span><span class="p">,</span>
    <span class="s2">&quot;chop&quot;</span><span class="p">:</span> <span class="s2">&quot;CHOP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uiowa&quot;</span><span class="p">:</span> <span class="s2">&quot;UIowa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stanford_image&quot;</span><span class="p">:</span> <span class="s2">&quot;Stanford (Non-Seq)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sickkids_silent_trial&quot;</span><span class="p">:</span> <span class="s2">&quot;SickKids (Silent Trial)&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1">################################################################################</span>
<span class="c1">#                           UMAP Plotting Functions                            #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="plot_umap">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.plot_umap">[docs]</a>
<span class="k">def</span> <span class="nf">plot_umap</span><span class="p">(</span><span class="n">embeds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">highlight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;tab10&quot;</span><span class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DIR_FIGURES</span><span class="p">,</span>
              <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">,</span> <span class="n">filename_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
              <span class="n">comet_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">scatterplot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot 2D U-Map of extracted image embeddings, colored by &lt;labels&gt;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    embeds : numpy.array</span>
<span class="sd">        A 2-dimensional array of N samples.</span>
<span class="sd">    labels : list</span>
<span class="sd">        Labels to color embeddings by. Must match number of samples (N).</span>
<span class="sd">    highlight : list, optional</span>
<span class="sd">        List of boolean values, corresponding to N samples. Those marked as</span>
<span class="sd">        False will appear softer (lower alpha value).</span>
<span class="sd">    label_order : list, optional</span>
<span class="sd">        Order of unique label values in legend, by default None.</span>
<span class="sd">    s : int, optional</span>
<span class="sd">        Size of scatterplot points, by default 5.</span>
<span class="sd">    alpha : float, optional</span>
<span class="sd">        Transparency of points in [0, 1], where closer to 1 is less transparent,</span>
<span class="sd">        by default 0.8</span>
<span class="sd">    line : bool, optional</span>
<span class="sd">        Connects points in scatterplot sequentially, by default False</span>
<span class="sd">    legend : bool, optional</span>
<span class="sd">        If True, shows legend, by default True.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Plot title, by default &quot;&quot;.</span>
<span class="sd">    palette : str, optional</span>
<span class="sd">        Seaborn color palette, by default &quot;tab10&quot;.</span>
<span class="sd">    save : bool, optional</span>
<span class="sd">        Filename , by default False</span>
<span class="sd">    save_dir : str, optional</span>
<span class="sd">        Directory to save plot image in</span>
<span class="sd">    filename : str, optional</span>
<span class="sd">        Filename to save plot as. Not including extension, by default &quot;umap&quot;</span>
<span class="sd">    filename_suffix : str, optional</span>
<span class="sd">        If provided, attach as suffix to filename provided, by default &quot;&quot;</span>
<span class="sd">    comet_logger : comet_ml.Experiment, optional</span>
<span class="sd">        If provided, log figure to Comet ML.</span>
<span class="sd">    **scatterplot_kwargs : Keyword arguments to pass into `sns.scatterplot`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Plot configurations</span>
    <span class="n">viz_utils</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">THEME</span><span class="p">)</span>

    <span class="c1"># If size of scatterplot dots not provided, default based on number of dots</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="mi">250</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeds</span><span class="p">)))</span>

    <span class="c1"># Create figure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="c1"># Draw line</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">embeds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">embeds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">size</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">//</span><span class="mi">5</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Draw scatterplot</span>
    <span class="k">if</span> <span class="n">highlight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">embeds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">embeds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">hue</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">hue_order</span><span class="o">=</span><span class="n">label_order</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;full&quot;</span> <span class="k">if</span> <span class="n">legend</span> <span class="k">else</span> <span class="n">legend</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">scatterplot_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">highlight</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeds</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Length of `embeds` and `highlight` do not match!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Draw highlighted points</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">embeds</span><span class="p">[</span><span class="n">highlight</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">embeds</span><span class="p">[</span><span class="n">highlight</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">hue</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">highlight</span><span class="p">],</span>
            <span class="n">hue_order</span><span class="o">=</span><span class="n">label_order</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">scatterplot_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Draw non-highlighted points</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">embeds</span><span class="p">[</span><span class="o">~</span><span class="n">highlight</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">embeds</span><span class="p">[</span><span class="o">~</span><span class="n">highlight</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">hue</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="o">~</span><span class="n">highlight</span><span class="p">],</span>
            <span class="n">hue_order</span><span class="o">=</span><span class="n">label_order</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;full&quot;</span> <span class="k">if</span> <span class="n">legend</span> <span class="k">else</span> <span class="n">legend</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">scatterplot_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Create legend</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

    <span class="c1"># Create title</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="c1"># Clear axes labels and ticks</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Pack plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Save Figure</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">umap/</span><span class="si">{</span><span class="n">filename</span><span class="si">}{</span><span class="n">filename_suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>

        <span class="c1"># Check if UMAP directory exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">umap/&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">umap/&quot;</span><span class="p">)</span>

        <span class="c1"># Check if subdirectory exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">full_path</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="c1"># Save figure to Comet</span>
    <span class="k">if</span> <span class="n">comet_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comet_logger</span><span class="o">.</span><span class="n">log_figure</span><span class="p">(</span>
            <span class="n">figure_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}{</span><span class="n">filename_suffix</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="n">figure</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">(),</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="plot_umap_all_patients">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.plot_umap_all_patients">[docs]</a>
<span class="k">def</span> <span class="nf">plot_umap_all_patients</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">df_data</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;patient&quot;</span><span class="p">,</span>
                           <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots UMAP for all patients, coloring by patient ID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    df_data : pd.DataFrame</span>
<span class="sd">        Contains extracted embeddings, view labels and dset labels.</span>
<span class="sd">    label_col : str</span>
<span class="sd">        Name of label column to color points by &quot;patient&quot; or by &quot;dset&quot;</span>
<span class="sd">    raw : bool, optional</span>
<span class="sd">        If True, loaded embeddings extracted from raw images. Otherwise, uses</span>
<span class="sd">        preprocessed images, by default False.</span>
<span class="sd">    **plot_kwargs : Keyword arguments to pass into `plot_umap`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Shuffle points to make each dset appear more</span>
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Get labels</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span>

    <span class="c1"># Get UMAP embeddings</span>
    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">int</span><span class="p">)]</span>
    <span class="n">umap_embeds</span> <span class="o">=</span> <span class="n">get_umap_embeddings</span><span class="p">(</span><span class="n">df_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])</span>

    <span class="c1"># Get label order</span>
    <span class="n">label_order</span> <span class="o">=</span> <span class="n">get_label_order</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="c1"># Plot by patient</span>
    <span class="n">plot_umap</span><span class="p">(</span>
        <span class="n">umap_embeds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;UMAP (colored by </span><span class="si">{</span><span class="n">label_col</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">label_order</span><span class="o">=</span><span class="n">label_order</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">/umap</span><span class="si">{</span><span class="s1">&#39;_raw&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">label_col</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="plot_umap_by_view">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.plot_umap_by_view">[docs]</a>
<span class="k">def</span> <span class="nf">plot_umap_by_view</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">df_data</span><span class="p">,</span>
                      <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                      <span class="n">dset_col</span><span class="o">=</span><span class="s2">&quot;dset&quot;</span><span class="p">,</span>
                      <span class="n">highlight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots UMAP for all view-labeled patients, coloring by view.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    df_data : pd.DataFrame</span>
<span class="sd">        Contains extracted embeddings, view labels and dset labels.</span>
<span class="sd">    label_col : str, optional</span>
<span class="sd">        Name of column in `df_data` with view label, by default &quot;label&quot;.</span>
<span class="sd">    dset_col : str, optional</span>
<span class="sd">        Name of column in `df_data` with dset label, by default &quot;dset&quot;.</span>
<span class="sd">    highlight : list, optional</span>
<span class="sd">        List of boolean values, corresponding to N samples. Those marked as</span>
<span class="sd">        False will appear softer (lower alpha value).</span>
<span class="sd">    raw : bool, optional</span>
<span class="sd">        If True, loaded embeddings extracted from raw images. Otherwise, uses</span>
<span class="sd">        preprocessed images, by default False.</span>
<span class="sd">    **plot_kwargs : Keyword arguments to pass into `plot_umap`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># INPUT: Ensure column names are in `df_data`</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">label_col</span><span class="p">,</span> <span class="n">dset_col</span><span class="p">]),</span> \
        <span class="s2">&quot;Specified label/dset column/s are NOT in `df_data`!&quot;</span>

    <span class="c1"># INPUT: Create copy of `plot_kwargs` to edit</span>
    <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Filter out image files w/o labels </span>
    <span class="n">idx_labeled</span> <span class="o">=</span> <span class="o">~</span><span class="n">df_data</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">idx_labeled</span><span class="p">]</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="n">highlight</span> <span class="k">if</span> <span class="n">highlight</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">highlight</span><span class="p">[</span><span class="n">idx_labeled</span><span class="p">]</span>

    <span class="c1"># Shuffle points to make each dset appear more</span>
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Get other metadata</span>
    <span class="n">view_labels</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span>
    <span class="n">dset_labels</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">dset_col</span><span class="p">]</span>

    <span class="c1"># Get unique dsets in data provided</span>
    <span class="n">unique_dsets</span> <span class="o">=</span> <span class="n">dset_labels</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="c1"># If 2+ dsets, add &quot;style&quot; parameter to identify marker shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_dsets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;style&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_labels</span>

    <span class="c1"># Map dset to more readable string</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">dset</span> <span class="ow">in</span> <span class="n">MAP_DSET_STR</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">unique_dsets</span><span class="p">)</span>
    <span class="n">dset_str</span> <span class="o">=</span> <span class="s2">&quot; &amp; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="n">MAP_DSET_STR</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">unique_dsets</span><span class="p">))</span>

    <span class="c1"># Construct folder name (with dset name)</span>
    <span class="c1"># 1. Attempt to shorten filename by grouping together dsets</span>
    <span class="n">fname_dsets</span> <span class="o">=</span> <span class="n">unique_dsets</span>
    <span class="n">group_dsets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sickkids&quot;</span><span class="p">,</span> <span class="s2">&quot;stanford&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">group_dset</span> <span class="ow">in</span> <span class="n">group_dsets</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_dset</span><span class="si">}</span><span class="s2">_&quot;</span> <span class="ow">in</span> <span class="n">dset</span>
                   <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">fname_dsets</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">fname_dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">dset</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">fname_dsets</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">group_dset</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">group_dset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fname_dsets</span><span class="p">:</span>
            <span class="n">fname_dsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_dset</span><span class="p">)</span>
    <span class="c1"># 2. Create folder name</span>
    <span class="n">dset_folder_name</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fname_dsets</span><span class="p">))</span>

    <span class="c1"># Extract UMAP embeddings</span>
    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">int</span><span class="p">)]</span>
    <span class="n">umap_embeds_views</span> <span class="o">=</span> <span class="n">get_umap_embeddings</span><span class="p">(</span><span class="n">df_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])</span>

    <span class="c1"># Label order</span>
    <span class="n">label_order</span> <span class="o">=</span> <span class="n">get_label_order</span><span class="p">(</span><span class="n">view_labels</span><span class="p">)</span>

    <span class="c1"># Plot all images by view</span>
    <span class="n">plot_umap</span><span class="p">(</span>
        <span class="n">umap_embeds_views</span><span class="p">,</span> <span class="n">view_labels</span><span class="p">,</span>
        <span class="n">highlight</span><span class="o">=</span><span class="n">highlight</span><span class="p">,</span>
        <span class="n">label_order</span><span class="o">=</span><span class="n">label_order</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;UMAP (</span><span class="si">{</span><span class="n">dset_str</span><span class="si">}</span><span class="s2">, colored by view)&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dset_folder_name</span><span class="si">}</span><span class="s2">/umap&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_raw&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">(views&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, highlighted&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">highlight</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;tab10&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_order</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s2">&quot;tab20&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="plot_umap_by_machine">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.plot_umap_by_machine">[docs]</a>
<span class="k">def</span> <span class="nf">plot_umap_by_machine</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">machine_labels</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span>
                         <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">dset</span><span class="o">=</span><span class="s2">&quot;SickKids&quot;</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots UMAP for all machine-labeled patients, coloring by machine.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    machine_labels : numpy.array</span>
<span class="sd">        Contains machine labels, corresponding to embeddings extracted. Images</span>
<span class="sd">        without label (null value) will be excluded</span>
<span class="sd">    filenames : pd.Series</span>
<span class="sd">        Contains file name of image whose features were extracted</span>
<span class="sd">    df_embeds_only : pd.DataFrame</span>
<span class="sd">        Extracted deep embeddings. Does not have file paths in any column.</span>
<span class="sd">    raw : bool, optional</span>
<span class="sd">        If True, loaded embeddings extracted from raw images. Otherwise, uses</span>
<span class="sd">        preprocessed images, by default False.</span>
<span class="sd">    dset : str, optional</span>
<span class="sd">        Name of dset with labels for images. One of (SickKids, Stanford,</span>
<span class="sd">        Both), by default &quot;SickKids&quot;.</span>
<span class="sd">    **plot_kwargs : Keyword arguments to pass into `plot_umap`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">dset</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SickKids&quot;</span><span class="p">,</span> <span class="s2">&quot;Stanford&quot;</span><span class="p">,</span> <span class="s2">&quot;Both&quot;</span><span class="p">)</span>

    <span class="c1"># Filter out image files w/o labels</span>
    <span class="n">idx_unlabeled</span> <span class="o">=</span> <span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">machine_labels</span><span class="p">)</span>
    <span class="n">machine_labels</span> <span class="o">=</span> <span class="n">machine_labels</span><span class="p">[</span><span class="n">idx_unlabeled</span><span class="p">]</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="n">idx_unlabeled</span><span class="p">]</span>
    <span class="n">df_embeds_only</span> <span class="o">=</span> <span class="n">df_embeds_only</span><span class="p">[</span><span class="n">idx_unlabeled</span><span class="p">]</span>

    <span class="c1"># Extract UMAP embeddings</span>
    <span class="n">umap_embeds_views</span> <span class="o">=</span> <span class="n">get_umap_embeddings</span><span class="p">(</span><span class="n">df_embeds_only</span><span class="p">)</span>

    <span class="c1"># Plot all images by view</span>
    <span class="n">plot_umap</span><span class="p">(</span><span class="n">umap_embeds_views</span><span class="p">,</span> <span class="n">machine_labels</span><span class="p">,</span>
              <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;UMAP (</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">, colored by machine)&quot;</span><span class="p">,</span>
              <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">/umap_</span><span class="si">{</span><span class="n">dset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_raw&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">(machine)&quot;</span><span class="p">,</span>
              <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_umap_for_one_patient_seq">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.plot_umap_for_one_patient_seq">[docs]</a>
<span class="k">def</span> <span class="nf">plot_umap_for_one_patient_seq</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">view_labels</span><span class="p">,</span> <span class="n">patient_visit</span><span class="p">,</span>
                                  <span class="n">us_nums</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;us_nums&quot;</span><span class="p">,</span>
                                  <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots UMAP for a single patient, colored by ultrasound number.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    view_labels : numpy.array</span>
<span class="sd">        Contains view labels, corresponding to embeddings extracted. Images</span>
<span class="sd">        without label (null value) will be excluded</span>
<span class="sd">    patient_visit : pd.Series</span>
<span class="sd">        Contains string of (patient ID)_(visit number), which forms a unique</span>
<span class="sd">        sequence identifier</span>
<span class="sd">    us_nums : pd.Series</span>
<span class="sd">        Contains number in ultrasound sequence capture</span>
<span class="sd">    df_embeds_only : pd.DataFrame</span>
<span class="sd">        Extracted deep embeddings. Does not have file paths in any column.</span>
<span class="sd">    color : str</span>
<span class="sd">        Option to color by US sequence number or view label. One of &quot;us_nums&quot;</span>
<span class="sd">        or &quot;views&quot;, by default &quot;us_nums&quot;.</span>
<span class="sd">    raw : bool, optional</span>
<span class="sd">        If True, loaded embeddings extracted from raw images. Otherwise, uses</span>
<span class="sd">        preprocessed images, by default False.</span>
<span class="sd">    **plot_kwargs : Keyword arguments to pass into `plot_umap`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">color</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;us_nums&quot;</span><span class="p">,</span> <span class="s2">&quot;views&quot;</span><span class="p">)</span>

    <span class="c1"># If coloring by label, filter out unlabeled</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">!=</span> <span class="s2">&quot;us_nums&quot;</span><span class="p">:</span>
        <span class="n">idx_unlabeled</span> <span class="o">=</span> <span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">view_labels</span><span class="p">)</span>
        <span class="n">view_labels</span> <span class="o">=</span> <span class="n">view_labels</span><span class="p">[</span><span class="n">idx_unlabeled</span><span class="p">]</span>
        <span class="n">patient_visit</span> <span class="o">=</span> <span class="n">patient_visit</span><span class="p">[</span><span class="n">idx_unlabeled</span><span class="p">]</span>
        <span class="n">us_nums</span> <span class="o">=</span> <span class="n">us_nums</span><span class="p">[</span><span class="n">idx_unlabeled</span><span class="p">]</span>
        <span class="n">df_embeds_only</span> <span class="o">=</span> <span class="n">df_embeds_only</span><span class="p">[</span><span class="n">idx_unlabeled</span><span class="p">]</span>

    <span class="c1"># Select a unique sequence (patient-visit)</span>
    <span class="n">patient_selected</span> <span class="o">=</span> <span class="n">patient_visit</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">idx_patient</span> <span class="o">=</span> <span class="p">(</span><span class="n">patient_visit</span> <span class="o">==</span> <span class="n">patient_selected</span><span class="p">)</span>
    <span class="n">view_labels</span> <span class="o">=</span> <span class="n">view_labels</span><span class="p">[</span><span class="n">idx_patient</span><span class="p">]</span>
    <span class="n">us_nums</span> <span class="o">=</span> <span class="n">us_nums</span><span class="p">[</span><span class="n">idx_patient</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_embeds_only</span> <span class="o">=</span> <span class="n">df_embeds_only</span><span class="p">[</span><span class="n">idx_patient</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Sort data points by US number</span>
    <span class="n">patient_us_nums</span> <span class="o">=</span> <span class="n">us_nums</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
    <span class="n">idx_sorted</span> <span class="o">=</span> <span class="n">patient_us_nums</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_embeds_only</span> <span class="o">=</span> <span class="n">df_embeds_only</span><span class="p">[</span><span class="n">idx_sorted</span><span class="p">]</span>
    <span class="n">view_labels</span> <span class="o">=</span> <span class="n">view_labels</span><span class="p">[</span><span class="n">idx_sorted</span><span class="p">]</span>

    <span class="c1"># Extract UMAP embeddings (for 1 patient)</span>
    <span class="n">umap_embeds_patient</span> <span class="o">=</span> <span class="n">get_umap_embeddings</span><span class="p">(</span><span class="n">df_embeds_only</span><span class="p">)</span>

    <span class="n">plot_umap</span><span class="p">(</span><span class="n">umap_embeds_patient</span><span class="p">,</span>
              <span class="n">patient_us_nums</span> <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;us_nums&quot;</span> <span class="k">else</span> <span class="n">view_labels</span><span class="p">,</span>
              <span class="n">line</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">legend</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;us_nums&quot;</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;UMAP (patient </span><span class="si">{</span><span class="n">patient_selected</span><span class="si">}</span><span class="s2">, colored by US number)&quot;</span><span class="p">,</span>
              <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span> <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;us_nums&quot;</span> <span class="k">else</span> <span class="s2">&quot;tab10&quot;</span><span class="p">,</span>
              <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">/umap_single</span><span class="si">{</span><span class="s1">&#39;_raw&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
              <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_umap_for_n_patient">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.plot_umap_for_n_patient">[docs]</a>
<span class="k">def</span> <span class="nf">plot_umap_for_n_patient</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">patients</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots UMAP for images from N chosen patient, colored by patient.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    patients : pd.Series</span>
<span class="sd">        Contains all patient IDs</span>
<span class="sd">    df_embeds_only : pd.DataFrame</span>
<span class="sd">        Extracted deep embeddings. Does not have file paths in any column.</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of patients to choose. If negative, show all, by default show all</span>
<span class="sd">    raw : bool, optional</span>
<span class="sd">        If True, loaded embeddings extracted from raw images. Otherwise, uses</span>
<span class="sd">        preprocessed images, by default False.</span>
<span class="sd">    **plot_kwargs : Keyword arguments to pass into `plot_umap`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE: Extract UMAP embeddings for ALL patients</span>
    <span class="n">umap_embeds_all</span> <span class="o">=</span> <span class="n">get_umap_embeddings</span><span class="p">(</span><span class="n">df_embeds_only</span><span class="p">)</span>

    <span class="c1"># Choose N patient</span>
    <span class="n">patients_selected</span> <span class="o">=</span> <span class="n">patients</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">patients_selected</span> <span class="o">=</span> <span class="n">patients</span><span class="o">.</span><span class="n">unique</span><span class="p">()[:</span><span class="n">n</span><span class="p">]</span>

    <span class="c1"># Filter UMAP embeddings for the chosen patients</span>
    <span class="n">idx_patients</span> <span class="o">=</span> <span class="n">patients</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">patients_selected</span><span class="p">)</span>
    <span class="n">umap_embeds_patients</span> <span class="o">=</span> <span class="n">umap_embeds_all</span><span class="p">[</span><span class="n">idx_patients</span><span class="p">]</span>
    <span class="n">patient_ids</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">idx_patients</span><span class="p">]</span>

    <span class="n">plot_umap</span><span class="p">(</span><span class="n">umap_embeds_patients</span><span class="p">,</span> <span class="n">patient_ids</span><span class="p">,</span>
              <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;UMAP (patients </span><span class="si">{</span><span class="n">patients_selected</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;colored by patient ID)&quot;</span><span class="p">,</span>
              <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">/umap</span><span class="si">{</span><span class="s1">&#39;_raw&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;(patient_id)&quot;</span><span class="p">,</span>
              <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_images_in_umap_clusters">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.plot_images_in_umap_clusters">[docs]</a>
<span class="k">def</span> <span class="nf">plot_images_in_umap_clusters</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots images in UMAP clusters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    filenames : pd.Series</span>
<span class="sd">        Contains file name of image whose features were extracted</span>
<span class="sd">    df_embeds_only : pd.DataFrame</span>
<span class="sd">        Extracted deep embeddings. Does not have file paths in any column.</span>
<span class="sd">    raw : bool, optional</span>
<span class="sd">        If True, loaded embeddings extracted from raw images. Otherwise, uses</span>
<span class="sd">        preprocessed images, by default False.</span>
<span class="sd">    **plot_kwargs : Keyword arguments to pass into `plot_umap`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get UMAP embeddings</span>
    <span class="n">umap_embeds_all</span> <span class="o">=</span> <span class="n">get_umap_embeddings</span><span class="p">(</span><span class="n">df_embeds_only</span><span class="p">)</span>

    <span class="c1"># Get cluster embeddings</span>
    <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">cluster_by_density</span><span class="p">(</span><span class="n">umap_embeds_all</span><span class="p">)</span>

    <span class="c1"># Plot example images in each cluster </span>
    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cluster_labels</span><span class="p">):</span>
        <span class="c1"># Filter by cluster, and sample 25 images</span>
        <span class="n">idx_cluster</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">)</span>
        <span class="n">cluster_filenames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">filenames</span><span class="p">[</span><span class="n">idx_cluster</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">idx_cluster</span><span class="p">)),</span>
            <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">################################################################################</span>
<span class="s2">#                              Cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s2">                               #</span>
<span class="s2">################################################################################</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Add directory to image paths</span>
        <span class="n">cluster_img_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">DSET_TO_IMG_SUBDIR_FULL</span><span class="p">[</span><span class="s2">&quot;sickkids&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">filename</span> \
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">cluster_filenames</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_img_paths</span><span class="p">))</span>

        <span class="c1"># Load images</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">cluster_img_paths</span><span class="p">])</span>

        <span class="c1"># Grid plot cluster images</span>
        <span class="n">viz_utils</span><span class="o">.</span><span class="n">gridplot_images</span><span class="p">(</span>
            <span class="n">imgs</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">/umap_cluster_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}{</span><span class="s1">&#39;_raw&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DIR_FIGURES_UMAP</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Plot UMAP with cluster labels</span>
    <span class="n">plot_umap</span><span class="p">(</span><span class="n">umap_embeds_all</span><span class="p">,</span> <span class="n">cluster_labels</span><span class="p">,</span>
              <span class="n">label_order</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cluster_labels</span><span class="p">)),</span>
              <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;UMAP (colored by cluster label)&quot;</span><span class="p">,</span>
              <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">/umap</span><span class="si">{</span><span class="s1">&#39;_raw&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;(cluster_labels)&quot;</span><span class="p">,</span>
              <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span></div>



<span class="c1">################################################################################</span>
<span class="c1">#                               Helper Functions                               #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="get_umap_embeddings">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.get_umap_embeddings">[docs]</a>
<span class="k">def</span> <span class="nf">get_umap_embeddings</span><span class="p">(</span><span class="n">df_embeds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get 2D-UMAP embeddings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_embeds : pd.DataFrame</span>
<span class="sd">        Contains embeddings for images</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>
<span class="sd">        2-dimensional UMAP embeddings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Standardize embeddings</span>
    <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_embeds</span><span class="p">)</span>

    <span class="c1"># Perform dimensionality reduction</span>
    <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">umap_embeds</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">umap_embeds</span></div>



<div class="viewcode-block" id="cluster_by_density">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.cluster_by_density">[docs]</a>
<span class="k">def</span> <span class="nf">cluster_by_density</span><span class="p">(</span><span class="n">embeds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cluster embeddings by density.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    embeds : pd.Series or np.array</span>
<span class="sd">        Extracted embeddings of the shape: (num_samples, num_features)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.array</span>
<span class="sd">        Assigned cluster labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">embeds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clusters</span><span class="o">.</span><span class="n">labels_</span></div>



<div class="viewcode-block" id="get_label_order">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.get_label_order">[docs]</a>
<span class="k">def</span> <span class="nf">get_label_order</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given example labels, return the label.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : list</span>
<span class="sd">        Example labels</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Order of labels, or None, if unable to find the label order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label_order</span> <span class="ow">in</span> <span class="p">(</span><span class="n">VIEW_LABEL_ORDER</span><span class="p">,</span> <span class="n">SIDE_LABEL_ORDER</span><span class="p">,</span> <span class="n">PLANE_LABEL_ORDER</span><span class="p">,</span>
                        <span class="n">HOSPITAL_LABEL_ORDER</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">labels</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">label_order</span><span class="p">)):</span>
            <span class="c1"># Filter for existing</span>
            <span class="n">label_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_order</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">label_order</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<span class="c1">################################################################################</span>
<span class="c1">#                                 Main Method                                  #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span>
         <span class="n">dset</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_EVAL_SPLIT</span><span class="p">,</span>
         <span class="n">split</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
         <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">segmented</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">reverse_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">dset_umap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">view_umap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">highlight_label_boundary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">one_seq_umap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">machine_umap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">n_patient_umap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">cluster_umap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">comet_exp_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves embeddings from specified pretrained model. Then plot UMAPs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_name : str</span>
<span class="sd">        Name of experiment</span>
<span class="sd">    dset : str or list, optional</span>
<span class="sd">        1+ datasets, whose embeddings to plot</span>
<span class="sd">    split : str or list, optional</span>
<span class="sd">        Data split to use for each `dset`</span>
<span class="sd">    raw : bool, optional</span>
<span class="sd">        If True, loads embeddings extracted from raw images. Otherwise, uses</span>
<span class="sd">        preprocessed images, by default False.</span>
<span class="sd">    segmented : bool, optional</span>
<span class="sd">        If True, loads embeddings extracted from segmented images, by default</span>
<span class="sd">        False.</span>
<span class="sd">    reverse_mask : bool, optional</span>
<span class="sd">        If True, loads embeddings extracted from segmented images where the mask</span>
<span class="sd">        is reversed, by default False.</span>
<span class="sd">    comet_exp_key : str, optional</span>
<span class="sd">        If provided, log UMAPs to Comet ML.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># INPUT: Load Comet ML Logger</span>
    <span class="n">comet_logger</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">comet_exp_key</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging UMAPs to Comet ML!&quot;</span><span class="p">)</span>
        <span class="n">comet_logger</span> <span class="o">=</span> <span class="n">load_comet_logger</span><span class="p">(</span><span class="n">exp_key</span><span class="o">=</span><span class="n">comet_exp_key</span><span class="p">)</span>

    <span class="c1"># INPUT: Ensure `dset` and `split` are lists</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">dset</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">dset</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">split</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">),</span> <span class="s2">&quot;Length of `dsets` and `splits` do not match!&quot;</span>

    <span class="c1"># Load embeddings</span>
    <span class="n">all_embed_lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsets</span><span class="p">):</span>
        <span class="c1"># If specified, use all splits</span>
        <span class="n">curr_split</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">curr_splits</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">curr_split</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="n">curr_split</span><span class="p">]</span>

        <span class="c1"># Load embeddings for specified split (or all splits)</span>
        <span class="k">for</span> <span class="n">curr_split</span> <span class="ow">in</span> <span class="n">curr_splits</span><span class="p">:</span>
            <span class="n">df_embeds</span> <span class="o">=</span> <span class="n">get_embeds</span><span class="p">(</span>
                <span class="n">exp_name</span><span class="p">,</span>
                <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span>
                <span class="n">split</span><span class="o">=</span><span class="n">curr_split</span><span class="p">,</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                <span class="n">segmented</span><span class="o">=</span><span class="n">segmented</span><span class="p">,</span>
                <span class="n">reverse_mask</span><span class="o">=</span><span class="n">reverse_mask</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Rename old filename column</span>
            <span class="n">df_embeds</span> <span class="o">=</span> <span class="n">df_embeds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="s2">&quot;filename&quot;</span><span class="p">})</span>
            <span class="c1"># Add dset and split</span>
            <span class="n">df_embeds</span><span class="p">[</span><span class="s2">&quot;dset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span>
            <span class="n">df_embeds</span><span class="p">[</span><span class="s2">&quot;split&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_split</span>
            <span class="n">all_embed_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_embeds</span><span class="p">)</span>

    <span class="c1"># Concatenate embeddings</span>
    <span class="n">df_embeds_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_embed_lst</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Extract metadata from image file paths</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df_metadata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_data_from_filename_and_join</span><span class="p">(</span>
            <span class="n">df_embeds_all</span><span class="p">,</span>
            <span class="n">dset</span><span class="o">=</span><span class="n">dsets</span><span class="p">,</span>
            <span class="n">label_part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># If errored, print experiment name</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">error_msg</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;[plot_umap] Failed to extract metadata for experiment:&quot;</span>
                        <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">error_msg</span>

    <span class="c1"># 0. Extract each metadata individually</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="n">patient_visits</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;visit&quot;</span><span class="p">])]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">us_nums</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;seq_number&quot;</span><span class="p">]</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">view_labels</span> <span class="o">=</span> <span class="n">df_metadata</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># 0. Isolate embedding columns</span>
    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_embeds_all</span><span class="o">.</span><span class="n">columns</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">int</span><span class="p">)]</span>
    <span class="n">df_embeds_only</span> <span class="o">=</span> <span class="n">df_embeds_all</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>

    <span class="c1"># 0. Create table with both embeddings and metadata</span>
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_embeds_only</span><span class="p">,</span> <span class="n">df_metadata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">df_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>

    <span class="c1"># 0. Shared UMAP kwargs</span>
    <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;filename_suffix&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dsets</span><span class="p">)))</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">splits</span><span class="p">)))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;comet_logger&quot;</span><span class="p">:</span> <span class="n">comet_logger</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># 1. Plot UMAP of all patients, colored by dset</span>
    <span class="k">if</span> <span class="n">dset_umap</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plot_umap_all_patients</span><span class="p">(</span>
            <span class="n">exp_name</span><span class="p">,</span> <span class="n">df_data</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;dset&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">one_seq_umap</span><span class="p">:</span>
        <span class="c1"># 2. Plot UMAP of one patient, colored by number in sequence</span>
        <span class="n">plot_umap_for_one_patient_seq</span><span class="p">(</span>
            <span class="n">exp_name</span><span class="p">,</span> <span class="n">view_labels</span><span class="p">,</span> <span class="n">patient_visits</span><span class="p">,</span> <span class="n">us_nums</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;us_nums&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
        <span class="c1"># 3. Plot UMAP for one unique US sequence, colored by view</span>
        <span class="c1"># NOTE: Only keeps images with labels in provided df_labels</span>
        <span class="n">plot_umap_for_one_patient_seq</span><span class="p">(</span>
            <span class="n">exp_name</span><span class="p">,</span> <span class="n">view_labels</span><span class="p">,</span> <span class="n">patient_visits</span><span class="p">,</span> <span class="n">us_nums</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;views&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

    <span class="c1"># 4. Plot UMAP of patients, colored by view</span>
    <span class="k">if</span> <span class="n">view_umap</span><span class="p">:</span>
        <span class="c1"># 4.1 Plot UMAP with view labels</span>
        <span class="n">plot_umap_by_view</span><span class="p">(</span>
            <span class="n">exp_name</span><span class="p">,</span>
            <span class="n">df_data</span><span class="o">=</span><span class="n">df_data</span><span class="p">,</span>
            <span class="n">dset_col</span><span class="o">=</span><span class="s2">&quot;dset&quot;</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

        <span class="c1"># 4.2 Plot UMAP, highlighting label boundaries</span>
        <span class="k">if</span> <span class="n">highlight_label_boundary</span><span class="p">:</span>
            <span class="n">highlight</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_label_boundaries</span><span class="p">(</span><span class="n">df_metadata</span><span class="p">)</span>
            <span class="n">plot_umap_by_view</span><span class="p">(</span>
                <span class="n">exp_name</span><span class="p">,</span>
                <span class="n">df_data</span><span class="o">=</span><span class="n">df_data</span><span class="p">,</span>
                <span class="n">dset_col</span><span class="o">=</span><span class="s2">&quot;dset&quot;</span><span class="p">,</span>
                <span class="n">highlight</span><span class="o">=</span><span class="n">highlight</span><span class="p">,</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

    <span class="c1"># 5. Plot UMAP of patients, colored by machine label</span>
    <span class="k">if</span> <span class="n">machine_umap</span><span class="p">:</span>
        <span class="c1"># Get machine labels (if any) for all extracted images</span>
        <span class="n">machine_labels</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_machine_for_filenames</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
        <span class="c1"># Plot UMAP</span>
        <span class="n">plot_umap_by_machine</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">machine_labels</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span>
                             <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="s2">&quot;SickKids&quot;</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

    <span class="c1"># 6. Plot UMAP for N patients, colored by patient ID</span>
    <span class="k">if</span> <span class="n">n_patient_umap</span><span class="p">:</span>
        <span class="n">plot_umap_for_n_patient</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">patients</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span>
                                <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

    <span class="c1"># 7. Plot example images from UMAP clusters</span>
    <span class="k">if</span> <span class="n">cluster_umap</span><span class="p">:</span>
        <span class="n">plot_images_in_umap_clusters</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">df_embeds_only</span><span class="p">,</span>
                                     <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

    <span class="c1"># Close all figures</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>



<span class="c1">################################################################################</span>
<span class="c1">#                                  User Input                                  #</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="init">
<a class="viewcode-back" href="../../../src.data_viz.html#src.data_viz.plot_umap.init">[docs]</a>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize ArgumentParser arguments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : argparse.ArgumentParser</span>
<span class="sd">        ArgumentParser object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arg_help</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;exp_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Name of experiment&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dsets&quot;</span><span class="p">:</span> <span class="s2">&quot;Name of datasets to plot UMAP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;splits&quot;</span><span class="p">:</span> <span class="s2">&quot;For each `dset`, what data split to plot UMAP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;comet_exp_key&quot;</span><span class="p">:</span> <span class="s2">&quot;If logging to Comet ML, the Experiment key&quot;</span>
    <span class="p">}</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--exp_name&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;exp_name&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dsets&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;dsets&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--splits&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--comet_exp_key&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">arg_help</span><span class="p">[</span><span class="s2">&quot;comet_exp_key&quot;</span><span class="p">])</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># 0. Initialize parser</span>
    <span class="n">PARSER</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">init</span><span class="p">(</span><span class="n">PARSER</span><span class="p">)</span>

    <span class="c1"># 1. Parse arguments</span>
    <span class="n">ARGS</span> <span class="o">=</span> <span class="n">PARSER</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># 1.1. Preprocess arguments</span>
    <span class="c1"># INPUT: Ensure `dset` and `split` are lists</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">ARGS</span><span class="o">.</span><span class="n">dsets</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">ARGS</span><span class="o">.</span><span class="n">splits</span>
    <span class="c1"># If only one of dset/split is &gt; 1, assume it&#39;s meant to be broadcast</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Only 1 `dset` provided! Assuming same `dset` for all `splits`...&quot;</span><span class="p">)</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="n">dsets</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Only 1 `split` provided! Assuming same `split` for all `dsets`...&quot;</span><span class="p">)</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">splits</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span>

    <span class="c1"># 2. Run main flow</span>
    <span class="k">for</span> <span class="n">EXP_NAME</span> <span class="ow">in</span> <span class="n">ARGS</span><span class="o">.</span><span class="n">exp_name</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsets</span><span class="p">):</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">main</span><span class="p">(</span><span class="n">exp_name</span><span class="o">=</span><span class="n">EXP_NAME</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                 <span class="n">comet_exp_key</span><span class="o">=</span><span class="n">ARGS</span><span class="o">.</span><span class="n">comet_exp_key</span><span class="p">)</span>
        <span class="n">main</span><span class="p">(</span><span class="n">exp_name</span><span class="o">=</span><span class="n">EXP_NAME</span><span class="p">,</span> <span class="n">dset</span><span class="o">=</span><span class="n">dsets</span><span class="p">,</span> <span class="n">comet_exp_key</span><span class="o">=</span><span class="n">ARGS</span><span class="o">.</span><span class="n">comet_exp_key</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Stanley Hua.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>